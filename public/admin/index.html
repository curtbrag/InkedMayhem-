<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”¥</text></svg>">
    <title>Admin â€” InkedMayhem</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Cormorant+Garamond:ital,wght@0,400;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #060606;
            --dark: #0d0d0d;
            --darker: #141414;
            --surface: #1a1a1a;
            --border: #222;
            --mid: #333;
            --gray: #555;
            --light-gray: #888;
            --muted: #aaa;
            --off-white: #e8e4df;
            --cream: #cdc6bc;
            --white: #f0ece6;
            --red: #c22020;
            --red-bright: #e63030;
            --gold: #c9a84c;
            --green: #2e7d32;
            --font-display: 'Bebas Neue', sans-serif;
            --font-serif: 'Cormorant Garamond', serif;
            --font-mono: 'Space Mono', monospace;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--black);
            color: var(--off-white);
            font-family: var(--font-mono);
            font-size: 12px;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* â”€â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }
        .login-box {
            background: var(--darker);
            border: 1px solid var(--border);
            padding: 3rem;
            max-width: 380px;
            width: 100%;
            text-align: center;
        }
        .login-box h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            letter-spacing: 3px;
            margin-bottom: 0.5rem;
        }
        .login-box h1 span { color: var(--red); }
        .login-box p {
            color: var(--muted);
            margin-bottom: 2rem;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .login-input {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--off-white);
            padding: 0.85rem 1rem;
            font-family: var(--font-mono);
            font-size: 12px;
            margin-bottom: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        .login-input:focus { border-color: var(--red); }
        .login-input::placeholder { color: var(--gray); }
        .login-btn {
            width: 100%;
            background: var(--red);
            color: var(--white);
            border: none;
            padding: 0.85rem;
            font-family: var(--font-mono);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .login-btn:hover { background: var(--red-bright); }
        .login-error {
            color: var(--red-bright);
            font-size: 11px;
            margin-top: 1rem;
            display: none;
        }

        /* â”€â”€â”€ DASHBOARD LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dashboard { display: none; }
        .dash-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: var(--darker);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .dash-logo {
            font-family: var(--font-display);
            font-size: 1.5rem;
            letter-spacing: 2px;
            text-decoration: none;
            color: var(--off-white);
        }
        .dash-logo span { color: var(--red); }
        .dash-actions { display: flex; gap: 1rem; align-items: center; }
        .dash-actions a, .dash-actions button {
            background: none;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 0.5rem 1rem;
            font-family: var(--font-mono);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }
        .dash-actions a:hover, .dash-actions button:hover {
            color: var(--off-white);
            border-color: var(--mid);
        }

        /* â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            background: var(--dark);
            overflow-x: auto;
        }
        .tab {
            padding: 1rem 2rem;
            font-family: var(--font-mono);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }
        .tab:hover { color: var(--off-white); }
        .tab.active {
            color: var(--red);
            border-bottom-color: var(--red);
        }
        .tab .badge {
            background: var(--red);
            color: #fff;
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 9px;
            margin-left: 6px;
            vertical-align: top;
        }
        .tab-content { display: none; padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .tab-content.active { display: block; }

        /* â”€â”€â”€ STATS CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--darker);
            border: 1px solid var(--border);
            padding: 1.5rem;
        }
        .stat-card .label {
            color: var(--muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 0.5rem;
        }
        .stat-card .value {
            font-family: var(--font-display);
            font-size: 2.5rem;
            color: var(--white);
            line-height: 1;
        }
        .stat-card .sub {
            color: var(--gray);
            font-size: 10px;
            margin-top: 0.35rem;
        }
        .stat-card.red .value { color: var(--red); }
        .stat-card.gold .value { color: var(--gold); }

        /* â”€â”€â”€ TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .table-wrap {
            overflow-x: auto;
            background: var(--darker);
            border: 1px solid var(--border);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: var(--surface);
            color: var(--muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            padding: 0.85rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            vertical-align: middle;
        }
        tr:hover { background: rgba(255,255,255,0.02); }

        .tier-badge {
            display: inline-block;
            padding: 2px 10px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid;
        }
        .tier-free { color: var(--muted); border-color: var(--mid); }
        .tier-peek { color: var(--red); border-color: var(--red); }
        .tier-vip { color: var(--gold); border-color: var(--gold); }
        .tier-elite { color: #fff; border-color: #fff; background: rgba(255,255,255,0.08); }

        .unread { background: rgba(194, 32, 32, 0.06); }
        .dot-unread {
            display: inline-block;
            width: 7px;
            height: 7px;
            background: var(--red);
            border-radius: 50%;
            margin-right: 6px;
        }

        /* â”€â”€â”€ ACTION BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-sm {
            background: none;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 3px 10px;
            font-family: var(--font-mono);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 4px;
        }
        .btn-sm:hover { color: var(--off-white); border-color: var(--mid); }
        .btn-sm.danger:hover { color: var(--red-bright); border-color: var(--red); }
        .btn-sm.primary { border-color: var(--red); color: var(--red); }
        .btn-sm.primary:hover { background: var(--red); color: #fff; }

        /* â”€â”€â”€ MESSAGE DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .msg-detail {
            background: var(--darker);
            border: 1px solid var(--border);
            padding: 2rem;
            margin-top: 1rem;
            display: none;
        }
        .msg-detail.active { display: block; }
        .msg-meta {
            color: var(--muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
        }
        .msg-body {
            color: var(--off-white);
            font-size: 13px;
            line-height: 1.8;
            padding: 1.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }
        .reply-box {
            display: flex;
            gap: 0.5rem;
        }
        .reply-input {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--off-white);
            padding: 0.75rem 1rem;
            font-family: var(--font-mono);
            font-size: 12px;
            outline: none;
            resize: vertical;
            min-height: 40px;
        }
        .reply-input:focus { border-color: var(--red); }
        .reply-send {
            background: var(--red);
            color: #fff;
            border: none;
            padding: 0.75rem 1.5rem;
            font-family: var(--font-mono);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            align-self: flex-end;
        }
        .reply-send:hover { background: var(--red-bright); }

        /* â”€â”€â”€ CONVERSATION THREAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .thread {
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }
        .thread-msg {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            max-width: 80%;
        }
        .thread-msg.from-user {
            background: var(--darker);
            border: 1px solid var(--border);
            margin-right: auto;
        }
        .thread-msg.from-admin {
            background: rgba(194, 32, 32, 0.12);
            border: 1px solid rgba(194, 32, 32, 0.3);
            margin-left: auto;
        }
        .thread-msg .msg-time {
            color: var(--gray);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.35rem;
        }

        /* â”€â”€â”€ COMPOSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .compose-form {
            background: var(--darker);
            border: 1px solid var(--border);
            padding: 2rem;
            margin-top: 1rem;
        }
        .compose-form label {
            display: block;
            color: var(--muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        .compose-form input, .compose-form textarea {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--off-white);
            padding: 0.75rem 1rem;
            font-family: var(--font-mono);
            font-size: 12px;
            margin-bottom: 1rem;
            outline: none;
        }
        .compose-form textarea { min-height: 120px; resize: vertical; }
        .compose-form input:focus, .compose-form textarea:focus { border-color: var(--red); }

        /* â”€â”€â”€ SECTION TITLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            letter-spacing: 2px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .section-title .icon { color: var(--red); }

        /* â”€â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .empty {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }
        .empty .icon { font-size: 2rem; margin-bottom: 1rem; }

        /* â”€â”€â”€ SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        select {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--off-white);
            padding: 3px 8px;
            font-family: var(--font-mono);
            font-size: 11px;
            outline: none;
            cursor: pointer;
        }

        /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 0.85rem 1.5rem;
            font-family: var(--font-mono);
            font-size: 11px;
            letter-spacing: 1px;
            z-index: 9999;
            transition: all 0.3s;
        }
        .toast-ok { background: var(--surface); color: var(--off-white); border: 1px solid var(--mid); }
        .toast-err { background: #2a0808; color: var(--red-bright); border: 1px solid var(--red); }

        /* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            .dash-header { padding: 1rem; }
            .tab-content { padding: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            td, th { font-size: 11px; padding: 0.5rem; }
            .msg-detail { padding: 1rem; }
            .thread-msg { max-width: 95%; }
        }

        /* â”€â”€â”€ LOADING SPINNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--mid);
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            color: var(--muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 2rem;
            text-align: center;
        }

        .back-link {
            color: var(--muted);
            text-decoration: none;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 1rem;
        }
        .back-link:hover { color: var(--off-white); }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen" class="login-screen">
    <div class="login-box">
        <h1>INKED<span>MAYHEM</span></h1>
        <p>Admin Dashboard</p>
        <form id="loginForm">
            <input type="password" class="login-input" id="adminPass" placeholder="Admin password" autocomplete="current-password" autofocus>
            <button type="submit" class="login-btn" id="loginBtn">Enter</button>
        </form>
        <div class="login-error" id="loginError">Invalid password</div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboard" class="dashboard">
    <!-- HEADER -->
    <header class="dash-header">
        <a href="/admin" class="dash-logo">INKED<span>MAYHEM</span> âš¡ ADMIN</a>
        <div class="dash-actions">
            <a href="/" target="_blank">View Site</a>
            <button onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="users">Users</button>
        <button class="tab" data-tab="messages">Messages <span class="badge" id="unreadBadge" style="display:none">0</span></button>
        <button class="tab" data-tab="conversations">Conversations</button>
    </div>

    <!-- â”€â”€â”€ OVERVIEW TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content active" id="tab-overview">
        <div class="section-title"><span class="icon">â—†</span> Dashboard</div>
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="label">Total Users</div>
                <div class="value" id="statUsers">â€”</div>
            </div>
            <div class="stat-card red">
                <div class="label">Unread Messages</div>
                <div class="value" id="statUnread">â€”</div>
            </div>
            <div class="stat-card gold">
                <div class="label">Conversations</div>
                <div class="value" id="statConvos">â€”</div>
            </div>
            <div class="stat-card">
                <div class="label">Total Messages</div>
                <div class="value" id="statMsgs">â€”</div>
            </div>
        </div>

        <div class="section-title" style="font-size:1.3rem; margin-top: 2rem;"><span class="icon">â—†</span> Tier Breakdown</div>
        <div class="stats-grid" id="tierGrid">
            <div class="stat-card"><div class="label">Free</div><div class="value" id="tierFree">â€”</div></div>
            <div class="stat-card"><div class="label">Peek</div><div class="value" id="tierPeek" style="color:var(--red)">â€”</div></div>
            <div class="stat-card"><div class="label">VIP</div><div class="value" id="tierVip" style="color:var(--gold)">â€”</div></div>
            <div class="stat-card"><div class="label">Elite</div><div class="value" id="tierElite" style="color:#fff">â€”</div></div>
        </div>
    </div>

    <!-- â”€â”€â”€ USERS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content" id="tab-users">
        <div class="section-title"><span class="icon">â—†</span> Registered Users</div>
        <div id="usersLoading" class="loading-text"><span class="spinner"></span> Loading users...</div>
        <div class="table-wrap" id="usersTable" style="display:none">
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Name</th>
                        <th>Tier</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody"></tbody>
            </table>
        </div>
        <div class="empty" id="usersEmpty" style="display:none">
            <div class="icon">ğŸ‘¤</div>
            <p>No registered users yet</p>
        </div>
    </div>

    <!-- â”€â”€â”€ MESSAGES TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content" id="tab-messages">
        <div class="section-title"><span class="icon">â—†</span> Contact Messages</div>
        <div id="msgsLoading" class="loading-text"><span class="spinner"></span> Loading messages...</div>
        <div class="table-wrap" id="msgsTable" style="display:none">
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th>From</th>
                        <th>Subject</th>
                        <th>Preview</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="msgsBody"></tbody>
            </table>
        </div>
        <div class="msg-detail" id="msgDetail">
            <span class="back-link" onclick="closeMsgDetail()">â† Back to messages</span>
            <div class="msg-meta" id="msgDetailMeta"></div>
            <div class="msg-body" id="msgDetailBody"></div>
            <div id="msgReplies"></div>
            <div class="reply-box">
                <textarea class="reply-input" id="replyInput" placeholder="Type your reply..."></textarea>
                <button class="reply-send" id="replyBtn" onclick="sendReply()">Send</button>
            </div>
        </div>
        <div class="empty" id="msgsEmpty" style="display:none">
            <div class="icon">âœ‰ï¸</div>
            <p>No messages yet</p>
        </div>
    </div>

    <!-- â”€â”€â”€ CONVERSATIONS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content" id="tab-conversations">
        <div class="section-title"><span class="icon">â—†</span> Conversations</div>
        <div id="convoList">
            <div id="convosLoading" class="loading-text"><span class="spinner"></span> Loading conversations...</div>
            <div class="table-wrap" id="convosTable" style="display:none">
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Messages</th>
                            <th>Last Message</th>
                            <th>Last Activity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="convosBody"></tbody>
                </table>
            </div>
            <div class="empty" id="convosEmpty" style="display:none">
                <div class="icon">ğŸ’¬</div>
                <p>No conversations yet</p>
            </div>

            <!-- Compose new message -->
            <div class="compose-form" style="margin-top: 2rem">
                <div class="section-title" style="font-size: 1.2rem;"><span class="icon">â—†</span> Send New Message</div>
                <label>Recipient Email</label>
                <input type="email" id="composeEmail" placeholder="user@example.com">
                <label>Message</label>
                <textarea id="composeText" placeholder="Type your message..."></textarea>
                <button class="login-btn" style="max-width: 200px" onclick="composeSend()">Send Message</button>
            </div>
        </div>

        <!-- Thread view -->
        <div id="convoThread" style="display:none">
            <span class="back-link" onclick="closeThread()">â† Back to conversations</span>
            <div class="msg-meta" id="threadMeta"></div>
            <div class="thread" id="threadMessages"></div>
            <div class="reply-box">
                <textarea class="reply-input" id="threadReplyInput" placeholder="Type your message..."></textarea>
                <button class="reply-send" onclick="threadSend()">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN DASHBOARD â€” JavaScript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API = '/api/admin';
let TOKEN = localStorage.getItem('im_admin_token');
let currentMsgKey = null;
let currentConvKey = null;
let currentConvEmail = null;

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function headers() {
    return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` };
}

async function api(path, method = 'GET', body = null) {
    const opts = { method, headers: headers() };
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(`${API}${path}`, opts);
    return r.json();
}

document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const pass = document.getElementById('adminPass').value;
    const btn = document.getElementById('loginBtn');
    btn.textContent = 'Checking...';
    btn.disabled = true;

    try {
        const r = await fetch(`${API}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pass })
        });
        const data = await r.json();
        if (data.success) {
            TOKEN = data.token;
            localStorage.setItem('im_admin_token', TOKEN);
            showDashboard();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    } catch { document.getElementById('loginError').style.display = 'block'; }
    btn.textContent = 'Enter';
    btn.disabled = false;
});

function logout() {
    TOKEN = null;
    localStorage.removeItem('im_admin_token');
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('adminPass').value = '';
}

async function showDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadStats();
}

// Check existing session
if (TOKEN) {
    // Verify token still works
    fetch(`${API}/stats`, { headers: { 'Authorization': `Bearer ${TOKEN}` } })
        .then(r => r.json())
        .then(d => { if (d.success) showDashboard(); else logout(); })
        .catch(() => logout());
}

// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');

        // Load data for tab
        if (tab.dataset.tab === 'users') loadUsers();
        if (tab.dataset.tab === 'messages') loadMessages();
        if (tab.dataset.tab === 'conversations') loadConversations();
        if (tab.dataset.tab === 'overview') loadStats();
    });
});

// â”€â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
    try {
        const data = await api('/stats');
        if (!data.success) return;
        const s = data.stats;
        document.getElementById('statUsers').textContent = s.totalUsers;
        document.getElementById('statUnread').textContent = s.unreadMessages;
        document.getElementById('statConvos').textContent = s.totalConversations;
        document.getElementById('statMsgs').textContent = s.totalMessages;
        document.getElementById('tierFree').textContent = s.tiers.free || 0;
        document.getElementById('tierPeek').textContent = s.tiers.peek || 0;
        document.getElementById('tierVip').textContent = s.tiers.vip || 0;
        document.getElementById('tierElite').textContent = s.tiers.elite || 0;

        const badge = document.getElementById('unreadBadge');
        if (s.unreadMessages > 0) {
            badge.textContent = s.unreadMessages;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    } catch (e) { console.error('Stats error:', e); }
}

// â”€â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsers() {
    document.getElementById('usersLoading').style.display = 'block';
    document.getElementById('usersTable').style.display = 'none';
    document.getElementById('usersEmpty').style.display = 'none';

    try {
        const data = await api('/users');
        document.getElementById('usersLoading').style.display = 'none';

        if (!data.success || !data.users.length) {
            document.getElementById('usersEmpty').style.display = 'block';
            return;
        }

        const tbody = document.getElementById('usersBody');
        tbody.innerHTML = data.users.map(u => `
            <tr>
                <td>${esc(u.email)}</td>
                <td>${esc(u.name)}</td>
                <td>
                    <select onchange="updateUserTier('${esc(u.key)}', this.value)">
                        ${['free','peek','vip','elite'].map(t =>
                            `<option value="${t}" ${u.tier===t?'selected':''}>${t.toUpperCase()}</option>`
                        ).join('')}
                    </select>
                </td>
                <td>${formatDate(u.createdAt)}</td>
                <td>
                    <button class="btn-sm" onclick="messageUser('${esc(u.email)}')">Message</button>
                    <button class="btn-sm danger" onclick="deleteUser('${esc(u.key)}', '${esc(u.email)}')">Delete</button>
                </td>
            </tr>
        `).join('');
        document.getElementById('usersTable').style.display = 'block';
    } catch (e) {
        document.getElementById('usersLoading').style.display = 'none';
        toast('Failed to load users', true);
    }
}

async function updateUserTier(key, tier) {
    const data = await api('/users/update', 'POST', { userKey: key, tier });
    if (data.success) toast(`Tier updated to ${tier.toUpperCase()}`);
    else toast('Update failed', true);
}

async function deleteUser(key, email) {
    if (!confirm(`Delete user ${email}? This cannot be undone.`)) return;
    const data = await api('/users/delete', 'POST', { userKey: key });
    if (data.success) { toast('User deleted'); loadUsers(); loadStats(); }
    else toast('Delete failed', true);
}

function messageUser(email) {
    // Switch to conversations tab and pre-fill compose
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('[data-tab="conversations"]').classList.add('active');
    document.getElementById('tab-conversations').classList.add('active');
    document.getElementById('composeEmail').value = email;
    document.getElementById('composeText').focus();
    loadConversations();
}

// â”€â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMessages() {
    document.getElementById('msgsLoading').style.display = 'block';
    document.getElementById('msgsTable').style.display = 'none';
    document.getElementById('msgsEmpty').style.display = 'none';
    document.getElementById('msgDetail').classList.remove('active');

    try {
        const data = await api('/messages');
        document.getElementById('msgsLoading').style.display = 'none';

        if (!data.success || !data.messages.length) {
            document.getElementById('msgsEmpty').style.display = 'block';
            return;
        }

        const tbody = document.getElementById('msgsBody');
        tbody.innerHTML = data.messages.map(m => `
            <tr class="${m.read ? '' : 'unread'}" data-key="${esc(m.key)}">
                <td>${m.read ? '' : '<span class="dot-unread"></span>'}</td>
                <td>${esc(m.name || m.email)}</td>
                <td>${esc(m.subject || 'â€”')}</td>
                <td style="color:var(--muted); max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${esc((m.message || '').substring(0, 60))}</td>
                <td style="white-space:nowrap">${formatDate(m.receivedAt)}</td>
                <td>
                    <button class="btn-sm primary" onclick="openMessage('${esc(m.key)}')">Open</button>
                    <button class="btn-sm danger" onclick="deleteMessage('${esc(m.key)}')">Delete</button>
                </td>
            </tr>
        `).join('');
        document.getElementById('msgsTable').style.display = 'block';
    } catch (e) {
        document.getElementById('msgsLoading').style.display = 'none';
        toast('Failed to load messages', true);
    }
}

async function openMessage(key) {
    currentMsgKey = key;
    // Find in current data
    const data = await api('/messages');
    const msg = data.messages.find(m => m.key === key);
    if (!msg) return;

    // Mark as read
    if (!msg.read) {
        await api('/messages/read', 'POST', { messageKey: key });
        loadStats();
    }

    document.getElementById('msgsTable').style.display = 'none';
    document.getElementById('msgDetailMeta').innerHTML = `
        From: <strong>${esc(msg.name)}</strong> &lt;${esc(msg.email)}&gt;<br>
        Subject: ${esc(msg.subject || 'â€”')} &nbsp;|&nbsp; ${formatDate(msg.receivedAt)}
        ${msg.fromMember ? ' &nbsp;|&nbsp; <span style="color:var(--gold)">MEMBER</span>' : ''}
    `;
    document.getElementById('msgDetailBody').textContent = msg.message;

    // Show replies if any
    const repliesDiv = document.getElementById('msgReplies');
    if (msg.replies && msg.replies.length) {
        repliesDiv.innerHTML = '<div style="margin-bottom:1rem;color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:1px">Replies</div>' +
            msg.replies.map(r => `
                <div style="background:rgba(194,32,32,0.08);border:1px solid rgba(194,32,32,0.2);padding:0.75rem 1rem;margin-bottom:0.5rem">
                    <div style="color:var(--off-white);font-size:12px">${esc(r.text)}</div>
                    <div style="color:var(--gray);font-size:9px;margin-top:0.3rem">${formatDate(r.sentAt)}</div>
                </div>
            `).join('');
    } else {
        repliesDiv.innerHTML = '';
    }

    document.getElementById('replyInput').value = '';
    document.getElementById('msgDetail').classList.add('active');
}

function closeMsgDetail() {
    document.getElementById('msgDetail').classList.remove('active');
    document.getElementById('msgsTable').style.display = 'block';
    loadMessages();
}

async function sendReply() {
    const text = document.getElementById('replyInput').value.trim();
    if (!text || !currentMsgKey) return;

    const btn = document.getElementById('replyBtn');
    btn.textContent = 'Sending...';
    btn.disabled = true;

    try {
        const data = await api('/messages/reply', 'POST', { messageKey: currentMsgKey, reply: text });
        if (data.success) {
            toast('Reply sent');
            openMessage(currentMsgKey); // Refresh to show reply
        } else toast('Reply failed', true);
    } catch { toast('Reply failed', true); }

    btn.textContent = 'Send';
    btn.disabled = false;
}

async function deleteMessage(key) {
    if (!confirm('Delete this message?')) return;
    const data = await api('/messages/delete', 'POST', { messageKey: key });
    if (data.success) { toast('Deleted'); loadMessages(); loadStats(); }
    else toast('Failed', true);
}

// â”€â”€â”€ CONVERSATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadConversations() {
    document.getElementById('convoList').style.display = 'block';
    document.getElementById('convoThread').style.display = 'none';
    document.getElementById('convosLoading').style.display = 'block';
    document.getElementById('convosTable').style.display = 'none';
    document.getElementById('convosEmpty').style.display = 'none';

    try {
        const data = await api('/conversations');
        document.getElementById('convosLoading').style.display = 'none';

        if (!data.success || !data.conversations.length) {
            document.getElementById('convosEmpty').style.display = 'block';
            return;
        }

        const tbody = document.getElementById('convosBody');
        tbody.innerHTML = data.conversations.map(c => `
            <tr>
                <td>${esc(c.email)}</td>
                <td>${c.messageCount}</td>
                <td style="color:var(--muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                    ${c.lastFrom === 'admin' ? '<span style="color:var(--red)">You:</span> ' : ''}${esc(c.lastMessage)}
                </td>
                <td>${formatDate(c.lastAt)}</td>
                <td><button class="btn-sm primary" onclick="openThread('${esc(c.key)}', '${esc(c.email)}')">Open</button> <button class="btn-sm" style="background:#c22020" onclick="deleteConvo('${esc(c.key)}', '${esc(c.email)}')">Delete</button></td>
            </tr>
        `).join('');
        document.getElementById('convosTable').style.display = 'block';
    } catch (e) {
        document.getElementById('convosLoading').style.display = 'none';
        toast('Failed to load conversations', true);
    }
}

async function openThread(key, email) {
    currentConvKey = key;
    currentConvEmail = email;
    document.getElementById('convoList').style.display = 'none';
    document.getElementById('convoThread').style.display = 'block';
    document.getElementById('threadMeta').innerHTML = `Conversation with <strong>${esc(email)}</strong>`;

    const data = await api('/conversations/thread', 'POST', { convKey: key });
    if (!data.success) return;

    const container = document.getElementById('threadMessages');
    container.innerHTML = data.conversation.messages.map(m => `
        <div class="thread-msg from-${m.from === 'admin' ? 'admin' : 'user'}">
            <div>${esc(m.text)}</div>
            <div class="msg-time">${m.from === 'admin' ? 'You' : email} Â· ${formatDate(m.sentAt)}</div>
        </div>
    `).join('');
    container.scrollTop = container.scrollHeight;
    document.getElementById('threadReplyInput').value = '';
}

function closeThread() {
    document.getElementById('convoThread').style.display = 'none';
    document.getElementById('convoList').style.display = 'block';
    loadConversations();
}

async function threadSend() {
    const text = document.getElementById('threadReplyInput').value.trim();
    if (!text || !currentConvEmail) return;

    const data = await api('/conversations/send', 'POST', { email: currentConvEmail, text });
    if (data.success) {
        toast('Sent');
        openThread(currentConvKey, currentConvEmail);
    } else toast('Failed', true);
}

async function deleteConvo(key, email) {
    if (!confirm(`Delete entire conversation with ${email}?`)) return;
    try {
        await api('/conversations/delete', 'POST', { convKey: key });
        toast('Conversation deleted');
        loadConversations();
    } catch (e) { toast('Failed to delete', true); }
}

async function composeSend() {
    const email = document.getElementById('composeEmail').value.trim();
    const text = document.getElementById('composeText').value.trim();
    if (!email || !text) { toast('Email and message required', true); return; }

    const data = await api('/conversations/send', 'POST', { email, text });
    if (data.success) {
        toast('Message sent');
        document.getElementById('composeEmail').value = '';
        document.getElementById('composeText').value = '';
        loadConversations();
    } else toast('Failed', true);
}

// â”€â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

function formatDate(iso) {
    if (!iso || iso === 'â€”') return 'â€”';
    try {
        const d = new Date(iso);
        const now = new Date();
        const diff = now - d;
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
        if (diff < 604800000) return `${Math.floor(diff/86400000)}d ago`;
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    } catch { return iso; }
}

function toast(msg, err = false) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const t = document.createElement('div');
    t.className = `toast ${err ? 'toast-err' : 'toast-ok'}`;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2500);
}
</script>
</body>
</html>
