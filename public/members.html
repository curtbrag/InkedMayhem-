<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî•</text></svg>">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <title>Members ‚Äî InkedMayhem</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Cormorant+Garamond:ital,wght@0,400;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .members-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 7rem 2rem 4rem;
            min-height: 100vh;
        }
        .members-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
        }
        .members-header h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            letter-spacing: 4px;
        }
        .members-header h1 span { color: var(--red); }
        .tier-badge-display {
            font-size: 0.6rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            padding: 0.5rem 1.5rem;
            border: 1px solid var(--red);
            color: var(--red);
        }
        .locked-overlay {
            position: fixed;
            inset: 0;
            z-index: 8000;
            background: var(--black);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }
        .locked-overlay h2 {
            font-family: var(--font-display);
            font-size: 3rem;
            letter-spacing: 4px;
            margin: 1.5rem 0 1rem;
        }
        .locked-overlay p {
            color: var(--gray);
            max-width: 400px;
            margin-bottom: 2rem;
            font-size: 0.85rem;
        }
        .locked-overlay .lock-big { font-size: 4rem; opacity: 0.5; }
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .content-card {
            background: var(--darker);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s;
        }
        .content-card:hover {
            border-color: var(--mid);
            transform: translateY(-2px);
        }
        .content-card-media {
            aspect-ratio: 4/5;
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .content-card-media img {
            width: 100%; height: 100%;
            object-fit: cover;
        }
        .content-card-media .placeholder-msg {
            color: var(--gray);
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .content-tier-tag {
            position: absolute;
            top: 0.8rem; right: 0.8rem;
            background: var(--red);
            color: var(--white);
            font-size: 0.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            padding: 0.25rem 0.7rem;
        }
        .content-card-info {
            padding: 1.2rem;
        }
        .content-card-info h3 {
            font-family: var(--font-serif);
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }
        .content-card-info .content-date {
            font-size: 0.6rem;
            color: var(--gray);
            letter-spacing: 2px;
        }
        .content-sections {
            margin-bottom: 3rem;
        }
        .content-sections h2 {
            font-family: var(--font-display);
            font-size: 1.8rem;
            letter-spacing: 3px;
            margin-bottom: 1.5rem;
            color: var(--off-white);
        }
        .content-sections h2 .count {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--gray);
            margin-left: 0.5rem;
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
            border: 1px dashed var(--border);
        }
        .empty-state .placeholder-icon { font-size: 2rem; opacity: 0.3; margin-bottom: 1rem; display: block; }
        .msg-thread {
            background: var(--surface, #111);
            border: 1px solid var(--border);
            border-radius: 2px;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .msg-bubble {
            max-width: 80%;
            padding: 0.7rem 1rem;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            line-height: 1.5;
            border-radius: 2px;
        }
        .msg-bubble.from-user {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            margin-left: auto;
        }
        .msg-bubble.from-admin {
            background: rgba(196, 18, 48, 0.15);
            border: 1px solid rgba(196, 18, 48, 0.3);
        }
        .msg-bubble .msg-time {
            display: block;
            font-size: 0.55rem;
            color: var(--gray);
            margin-top: 0.4rem;
            letter-spacing: 1px;
        }
        .msg-bubble .msg-from {
            font-size: 0.55rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--red);
            margin-bottom: 0.3rem;
        }
        .msg-compose {
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
        }
        .msg-compose textarea {
            flex: 1;
            background: var(--surface, #111);
            border: 1px solid var(--border);
            color: var(--white);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            padding: 0.8rem;
            resize: none;
            outline: none;
        }
        .msg-compose textarea:focus { border-color: var(--red); }
        .msg-send-btn {
            background: var(--red);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            font-family: var(--font-display);
            font-size: 0.9rem;
            letter-spacing: 2px;
            cursor: pointer;
            white-space: nowrap;
        }
        .msg-send-btn:hover { opacity: 0.9; }
        .msg-empty {
            text-align: center;
            color: var(--gray);
            padding: 2rem;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <!-- AGE GATE -->
    <div id="ageGate" style="display:none;position:fixed;inset:0;z-index:99999;background:#060606;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:2rem">
        <div style="max-width:400px">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:3rem;letter-spacing:4px;margin-bottom:0.5rem">INKED<span style="color:#c22020">MAYHEM</span></div>
            <div style="color:#888;font-size:0.7rem;letter-spacing:3px;text-transform:uppercase;margin-bottom:2rem">Age Verification Required</div>
            <p style="color:#aaa;font-size:0.9rem;line-height:1.6;margin-bottom:2rem">This website contains content intended for adults. By entering, you confirm that you are at least 18 years old.</p>
            <div style="display:flex;gap:1rem;justify-content:center">
                <button onclick="verifyAge(true)" style="background:#c22020;color:#fff;border:none;padding:0.85rem 2.5rem;font-family:'Space Mono',monospace;font-size:0.7rem;text-transform:uppercase;letter-spacing:2px;cursor:pointer">I am 18+</button>
                <button onclick="verifyAge(false)" style="background:none;border:1px solid #333;color:#888;padding:0.85rem 2.5rem;font-family:'Space Mono',monospace;font-size:0.7rem;text-transform:uppercase;letter-spacing:2px;cursor:pointer">Exit</button>
            </div>
        </div>
    </div>
    <script>
    (function() {
        if (sessionStorage.getItem('im_age_verified')) return;
        fetch('/api/creator-config/features?id=inkedmayhem').then(r => r.json()).then(data => {
            if (data.success && data.features?.ageGate) {
                document.getElementById('ageGate').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }).catch(() => {});
    })();
    function verifyAge(ok) { if (ok) { sessionStorage.setItem('im_age_verified','1'); document.getElementById('ageGate').style.display='none'; document.body.style.overflow=''; } else { window.location.href='https://www.google.com'; } }
    </script>
    <div class="noise-overlay"></div>

    <!-- NAV -->
    <nav id="navbar" class="scrolled">
        <a href="/" class="nav-logo">INKED<span>MAYHEM</span></a>
        <div class="nav-right">
            <button class="btn-login" id="btnLogout">Sign Out</button>
        </div>
    </nav>

    <!-- LOCKED STATE (shown if not authenticated) -->
    <div class="locked-overlay" id="lockedOverlay">
        <span class="lock-big">üîí</span>
        <h2>MEMBERS ONLY</h2>
        <p>You need to sign in to access exclusive content. Already a member? Sign in below.</p>
        <a href="/" class="btn-primary">Sign In ‚Üí</a>
    </div>

    <!-- MEMBERS CONTENT (hidden until auth) -->
    <div class="members-page" id="membersContent" style="display: none;">
        <div class="members-header">
            <h1>YOUR <span>CONTENT</span></h1>
            <span class="tier-badge-display" id="userTierBadge">FREE</span>
        </div>

        <!-- MESSAGES -->
        <div class="content-sections" id="messagesSection">
            <h2>MESSAGES <span class="count" id="msgCount"></span></h2>
            <div class="msg-thread" id="msgThread">
                <div id="msgLoading" style="color:var(--gray);text-align:center;padding:2rem;">Loading messages...</div>
            </div>
            <div class="msg-compose">
                <textarea id="msgInput" placeholder="Send a message to InkedMayhem..." rows="2"></textarea>
                <button class="msg-send-btn" id="msgSendBtn" onclick="sendMsg()">Send ‚Üí</button>
            </div>
        </div>

        <!-- SEARCH & FILTER -->
        <div class="content-sections" style="padding-bottom:0;margin-bottom:0">
            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;align-items:center">
                <input type="text" id="contentSearch" placeholder="Search content..." oninput="filterContent()"
                    style="flex:1;min-width:200px;background:var(--surface);border:1px solid var(--border);color:var(--off-white);padding:0.6rem 1rem;font-family:var(--font-mono);font-size:12px;outline:none">
                <select id="categoryFilter" onchange="filterContent()"
                    style="background:var(--surface);border:1px solid var(--border);color:var(--off-white);padding:0.6rem 0.75rem;font-family:var(--font-mono);font-size:11px;min-width:130px">
                    <option value="">All Categories</option>
                </select>
                <select id="sortFilter" onchange="filterContent()"
                    style="background:var(--surface);border:1px solid var(--border);color:var(--off-white);padding:0.6rem 0.75rem;font-family:var(--font-mono);font-size:11px;min-width:110px">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                </select>
            </div>
        </div>

        <!-- LATEST DROPS (all tiers, most recent first) -->
        <div class="content-sections">
            <h2>LATEST DROPS <span class="count" id="latestCount"></span></h2>
            <div class="content-grid" id="latestContent">
                <div class="loading-text" style="padding:2rem;text-align:center;color:var(--muted)">Loading...</div>
            </div>
        </div>

        <!-- VIP CONTENT -->
        <div class="content-sections">
            <h2>VIP EXCLUSIVES <span class="count">(Ink Insider+)</span></h2>
            <div class="content-grid" id="vipContent">
                <div class="loading-text" style="padding:2rem;text-align:center;color:var(--muted)">Loading...</div>
            </div>
        </div>

        <!-- ELITE CONTENT -->
        <div class="content-sections">
            <h2>MAYHEM CIRCLE <span class="count">(Elite Only)</span></h2>
            <div class="content-grid" id="eliteContent">
                <div class="loading-text" style="padding:2rem;text-align:center;color:var(--muted)">Loading...</div>
            </div>
        </div>

        <!-- FREE CONTENT / ANNOUNCEMENTS -->
        <div class="content-sections">
            <h2>LATEST DROPS <span class="count">(All Members)</span></h2>
            <div class="content-grid" id="freeContent">
                <div class="loading-text" style="padding:2rem;text-align:center;color:var(--muted)">Loading...</div>
            </div>
        </div>

        <!-- PROFILE & SETTINGS -->
        <div class="content-sections" style="margin-top:3rem">
            <h2>MY ACCOUNT</h2>
            <div style="display:flex;gap:2rem;flex-wrap:wrap;margin-top:1rem">
                <div style="flex:1;min-width:280px;background:var(--surface);border:1px solid var(--border);padding:1.5rem">
                    <div style="font-size:0.65rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:1rem">Edit Profile</div>
                    <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">Display Name</label>
                    <input type="text" id="profileName" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--text);padding:0.5rem;margin-bottom:1rem;font-size:14px">
                    <button onclick="updateProfile()" style="font-family:var(--font-mono);font-size:11px;letter-spacing:2px;text-transform:uppercase;padding:0.5rem 1.5rem;background:var(--red);color:white;border:none;cursor:pointer">Save</button>
                    <div id="profileMsg" style="font-size:11px;margin-top:0.5rem;color:var(--gold);display:none"></div>
                </div>
                <div style="flex:1;min-width:280px;background:var(--surface);border:1px solid var(--border);padding:1.5rem">
                    <div style="font-size:0.65rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:1rem">Change Password</div>
                    <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">Current Password</label>
                    <input type="password" id="pwCurrent" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--text);padding:0.5rem;margin-bottom:0.75rem;font-size:14px">
                    <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">New Password</label>
                    <input type="password" id="pwNew" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--text);padding:0.5rem;margin-bottom:0.75rem;font-size:14px">
                    <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">Confirm New Password</label>
                    <input type="password" id="pwConfirm" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--text);padding:0.5rem;margin-bottom:1rem;font-size:14px">
                    <button onclick="changePassword()" style="font-family:var(--font-mono);font-size:11px;letter-spacing:2px;text-transform:uppercase;padding:0.5rem 1.5rem;background:var(--red);color:white;border:none;cursor:pointer">Change Password</button>
                    <div id="pwMsg" style="font-size:11px;margin-top:0.5rem;color:var(--gold);display:none"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentToken = null;

        document.addEventListener('DOMContentLoaded', () => {
            currentToken = localStorage.getItem('im_token');
            const userData = localStorage.getItem('im_user');

            if (currentToken && userData) {
                try {
                    currentUser = JSON.parse(userData);
                    document.getElementById('lockedOverlay').style.display = 'none';
                    document.getElementById('membersContent').style.display = 'block';
                    
                    const tierBadge = document.getElementById('userTierBadge');
                    const tierMap = { free: 'FREE', vip: 'INK INSIDER', elite: 'MAYHEM CIRCLE' };
                    tierBadge.textContent = tierMap[currentUser.tier] || 'FREE';

                    // Load fresh profile data
                    loadProfile();
                    // Load dynamic content
                    loadExclusiveContent();
                    // Load messages
                    loadMessages();
                } catch (e) {}
            }

            document.getElementById('btnLogout').addEventListener('click', () => {
                localStorage.removeItem('im_token');
                localStorage.removeItem('im_user');
                window.location.href = '/';
            });
        });

        // ‚îÄ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadProfile() {
            try {
                const r = await fetch('/api/me', { headers: { 'Authorization': `Bearer ${currentToken}` }});
                const data = await r.json();
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('im_user', JSON.stringify(data.user));
                    document.getElementById('profileName').value = data.user.name || '';
                    const tierMap = { free: 'FREE', vip: 'INK INSIDER', elite: 'MAYHEM CIRCLE' };
                    document.getElementById('userTierBadge').textContent = tierMap[data.user.tier] || 'FREE';
                }
            } catch (e) {}
        }

        async function updateProfile() {
            const name = document.getElementById('profileName').value.trim();
            if (!name) return;
            try {
                const r = await fetch('/api/me/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
                    body: JSON.stringify({ name })
                });
                const data = await r.json();
                const msg = document.getElementById('profileMsg');
                if (data.success) {
                    msg.textContent = '‚úì Name updated';
                    msg.style.color = 'var(--gold)';
                    currentUser.name = name;
                    localStorage.setItem('im_user', JSON.stringify(currentUser));
                } else {
                    msg.textContent = data.error || 'Update failed';
                    msg.style.color = 'var(--red)';
                }
                msg.style.display = 'block';
                setTimeout(() => { msg.style.display = 'none'; }, 3000);
            } catch (e) {}
        }

        async function changePassword() {
            const cur = document.getElementById('pwCurrent').value;
            const newPw = document.getElementById('pwNew').value;
            const conf = document.getElementById('pwConfirm').value;
            const msg = document.getElementById('pwMsg');

            if (!cur || !newPw || !conf) {
                msg.textContent = 'All fields required';
                msg.style.color = 'var(--red)';
                msg.style.display = 'block';
                return;
            }
            if (newPw !== conf) {
                msg.textContent = 'New passwords don\'t match';
                msg.style.color = 'var(--red)';
                msg.style.display = 'block';
                return;
            }
            if (newPw.length < 6) {
                msg.textContent = 'Password must be at least 6 characters';
                msg.style.color = 'var(--red)';
                msg.style.display = 'block';
                return;
            }

            try {
                const r = await fetch('/api/me/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
                    body: JSON.stringify({ currentPassword: cur, newPassword: newPw })
                });
                const data = await r.json();
                if (data.success) {
                    msg.textContent = '‚úì Password changed!';
                    msg.style.color = 'var(--gold)';
                    document.getElementById('pwCurrent').value = '';
                    document.getElementById('pwNew').value = '';
                    document.getElementById('pwConfirm').value = '';
                } else {
                    msg.textContent = data.error || 'Change failed';
                    msg.style.color = 'var(--red)';
                }
                msg.style.display = 'block';
                setTimeout(() => { msg.style.display = 'none'; }, 4000);
            } catch (e) {
                msg.textContent = 'Something went wrong';
                msg.style.color = 'var(--red)';
                msg.style.display = 'block';
            }
        }

        // ‚îÄ‚îÄ‚îÄ DYNAMIC CONTENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let allContent = [];

        async function loadExclusiveContent(search, category, sort) {
            try {
                let apiUrl = '/api/content?tier=' + (currentUser?.tier || 'free');
                if (search) apiUrl += '&search=' + encodeURIComponent(search);
                if (category) apiUrl += '&category=' + encodeURIComponent(category);
                if (sort) apiUrl += '&sort=' + encodeURIComponent(sort);

                const r = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await r.json();
                if (!data.success) return;

                allContent = data.content || [];

                // Build category filter options (only on initial load)
                if (!search && !category) {
                    const categories = [...new Set(allContent.map(c => c.category).filter(Boolean))];
                    const catSelect = document.getElementById('categoryFilter');
                    catSelect.innerHTML = '<option value="">All Categories</option>' +
                        categories.map(c => `<option value="${escAttr(c)}">${escHtml(c.charAt(0).toUpperCase() + c.slice(1))}</option>`).join('');
                }

                renderAllContent(allContent);
            } catch (e) {
                console.error('Content load error:', e);
            }
        }

        function renderAllContent(content) {
            // Latest drops ‚Äî all content the user can see, most recent first (max 6)
            const latestItems = content.slice(0, 6);
            renderContentGrid('latestContent', latestItems, 'all');
            document.getElementById('latestCount').textContent = content.length ? `(${content.length})` : '';

            const vipItems = content.filter(c => c.tier === 'vip');
            const eliteItems = content.filter(c => c.tier === 'elite');
            const freeItems = content.filter(c => c.tier === 'free');

            renderContentGrid('vipContent', vipItems, 'vip');
            renderContentGrid('eliteContent', eliteItems, 'elite');
            renderContentGrid('freeContent', freeItems, 'free');
        }

        let filterTimeout = null;
        function filterContent() {
            // Debounce server calls (300ms)
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                const query = (document.getElementById('contentSearch').value || '').trim();
                const category = document.getElementById('categoryFilter').value;
                const sort = document.getElementById('sortFilter').value;
                loadExclusiveContent(query || undefined, category || undefined, sort || undefined);
            }, 300);
        }

        function renderContentGrid(containerId, items, tier) {
            const container = document.getElementById(containerId);
            const userTier = currentUser?.tier || 'free';
            const tierOrder = { free: 0, vip: 1, elite: 2 };
            const hasAccess = tier === 'all' || tierOrder[userTier] >= tierOrder[tier];

            if (!items.length) {
                if (tier === 'free' || tier === 'all') {
                    container.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--muted);font-style:italic">New content drops coming soon!</div>';
                } else if (!hasAccess) {
                    container.innerHTML = `<div style="padding:2rem;text-align:center;color:var(--muted)">üîí Upgrade to ${tier.toUpperCase()} to unlock exclusive content <a href="/#exclusive" style="color:var(--red)">View Plans</a></div>`;
                } else {
                    container.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--muted);font-style:italic">Exclusive content coming soon ‚Äî stay tuned!</div>';
                }
                return;
            }

            container.innerHTML = items.map(c => {
                const itemTier = c.tier || 'free';
                const itemHasAccess = tier === 'all' || tierOrder[userTier] >= tierOrder[itemTier];

                if (!itemHasAccess) {
                    const purchased = currentUser?.purchases?.some(p => p.postId === c.key);
                    if (purchased) {
                        // User purchased this individual post ‚Äî show it
                    } else {
                        const priceLabel = c.price ? `$${Number(c.price).toFixed(2)}` : '$4.99';
                        return `<div class="content-card" style="opacity:0.6">
                            <div class="content-card-media">
                                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--surface)">
                                    <span style="font-size:2rem;opacity:0.4">üîí</span>
                                </div>
                                <span class="content-tier-tag">${itemTier.toUpperCase()}</span>
                            </div>
                            <div class="content-card-info">
                                <h3>${escHtml(c.title)}</h3>
                                <span class="content-date">
                                    <a href="/#exclusive" style="color:var(--red);text-decoration:none">Upgrade</a>
                                    ${c.key ? ` or <a href="#" onclick="unlockPost('${escAttr(c.key)}');return false" style="color:var(--gold);text-decoration:none">Unlock ${priceLabel}</a>` : ''}
                                </span>
                            </div>
                        </div>`;
                    }
                }

                const typeIcons = { post: 'üìù', gallery: 'üñºÔ∏è', video: 'üé¨', announcement: 'üì¢' };
                // Handle both external URLs and pipeline asset paths
                const hasImage = c.imageUrl && (c.imageUrl.startsWith('http') || c.imageUrl.startsWith('/api/'));
                const tierLabel = tier === 'all' ? itemTier.toUpperCase() : tier.toUpperCase();

                return `<div class="content-card" onclick="openContent(this)" data-body="${escAttr(c.body)}" data-title="${escAttr(c.title)}" data-image="${escAttr(c.imageUrl || '')}" data-type="${escAttr(c.type || 'post')}" data-category="${escAttr(c.category || '')}">
                    <div class="content-card-media">
                        ${hasImage
                            ? `<img src="${escHtml(c.imageUrl)}" alt="${escHtml(c.title)}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div style="width:100%;height:100%;display:none;align-items:center;justify-content:center;background:var(--surface);font-size:2rem">${typeIcons[c.type] || 'üñºÔ∏è'}</div>`
                            : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--surface);font-size:2rem">${typeIcons[c.type] || 'üìù'}</div>`
                        }
                        <span class="content-tier-tag">${tierLabel}</span>
                    </div>
                    <div class="content-card-info">
                        <h3>${escHtml(c.title)}</h3>
                        <span class="content-date">${c.category ? escHtml(c.category) + ' ¬∑ ' : ''}${new Date(c.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                    </div>
                </div>`;
            }).join('');
        }

        async function unlockPost(postKey) {
            if (!currentToken) { window.location.href = '/members'; return; }
            try {
                const r = await fetch('/api/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
                    body: JSON.stringify({ type: 'single', postId: postKey })
                });
                const data = await r.json();
                if (data.url) {
                    window.location.href = data.url;
                } else if (data.alreadyOwned) {
                    alert('You already own this content! Refreshing...');
                    location.reload();
                } else {
                    alert(data.error || 'Checkout failed');
                }
            } catch (e) {
                alert('Payment error. Please try again.');
            }
        }

        function openContent(el) {
            const title = el.dataset.title;
            const body = el.dataset.body;
            const image = el.dataset.image;
            const type = el.dataset.type;
            const category = el.dataset.category;

            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.95);overflow-y:auto;padding:2rem';

            const hasImage = image && (image.startsWith('http') || image.startsWith('/api/'));
            const isVideo = type === 'video';

            overlay.innerHTML = `
                <div style="max-width:700px;margin:2rem auto;color:var(--off-white,#e8e4df)">
                    <span onclick="this.parentElement.parentElement.remove()" style="position:fixed;top:1rem;right:1.5rem;cursor:pointer;font-size:1.5rem;color:var(--muted);z-index:10000">‚úï</span>
                    ${hasImage && !isVideo ? `<img src="${escHtml(image)}" style="width:100%;max-height:500px;object-fit:contain;margin-bottom:1.5rem;background:var(--surface)" onerror="this.style.display='none'">` : ''}
                    ${hasImage && isVideo ? `<video src="${escHtml(image)}" controls style="width:100%;max-height:500px;margin-bottom:1.5rem;background:var(--surface)"></video>` : ''}
                    ${category ? `<div style="font-size:0.6rem;letter-spacing:3px;text-transform:uppercase;color:var(--red);margin-bottom:0.5rem">${escHtml(category)}</div>` : ''}
                    <h1 style="font-family:var(--font-display);font-size:2rem;letter-spacing:2px;margin-bottom:1rem">${escHtml(title)}</h1>
                    <div style="line-height:1.8;color:var(--muted);font-size:15px">${body || '<em>No description</em>'}</div>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        }

        // ‚îÄ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadMessages() {
            if (!currentToken) return;
            try {
                const r = await fetch('/api/messages', { headers: { 'Authorization': `Bearer ${currentToken}` }});
                const data = await r.json();
                const thread = document.getElementById('msgThread');
                const msgs = data.messages || [];
                document.getElementById('msgCount').textContent = msgs.length ? `(${msgs.length})` : '';
                if (!msgs.length) {
                    thread.innerHTML = '<div class="msg-empty">No messages yet. Say hi! üëã</div>';
                    return;
                }
                thread.innerHTML = msgs.map(m => `
                    <div class="msg-bubble from-${m.from}">
                        ${m.from === 'admin' ? '<div class="msg-from">InkedMayhem</div>' : ''}
                        ${escHtml(m.text)}
                        <span class="msg-time">${new Date(m.at).toLocaleString()}</span>
                    </div>
                `).join('');
                thread.scrollTop = thread.scrollHeight;
            } catch (e) {
                document.getElementById('msgThread').innerHTML = '<div class="msg-empty">Could not load messages</div>';
            }
        }

        async function sendMsg() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text || !currentToken) return;
            const btn = document.getElementById('msgSendBtn');
            btn.textContent = 'Sending...';
            btn.disabled = true;
            try {
                const r = await fetch('/api/messages/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
                    body: JSON.stringify({ text })
                });
                const data = await r.json();
                if (data.success) {
                    input.value = '';
                    loadMessages();
                }
            } catch (e) {}
            btn.textContent = 'Send ‚Üí';
            btn.disabled = false;
        }

        function escHtml(s) {
            if (!s) return '';
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function escAttr(s) {
            if (!s) return '';
            return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
    </script>
</body>
</html>
