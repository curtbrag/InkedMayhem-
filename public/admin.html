<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”¥</text></svg>">
    <title>Admin â€” InkedMayhem</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Cormorant+Garamond:ital,wght@0,400;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #060606;
            --dark: #0d0d0d;
            --darker: #141414;
            --surface: #1a1a1a;
            --border: #222;
            --mid: #333;
            --gray: #555;
            --light-gray: #888;
            --muted: #aaa;
            --off-white: #e8e4df;
            --cream: #cdc6bc;
            --white: #f0ece6;
            --red: #c22020;
            --red-bright: #e63030;
            --gold: #c9a84c;
            --green: #2e7d32;
            --font-display: 'Bebas Neue', sans-serif;
            --font-serif: 'Cormorant Garamond', serif;
            --font-mono: 'Space Mono', monospace;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--black);
            color: var(--off-white);
            font-family: var(--font-mono);
            font-size: 12px;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* â”€â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }
        .login-box {
            background: var(--darker);
            border: 1px solid var(--border);
            padding: 3rem;
            max-width: 380px;
            width: 100%;
            text-align: center;
        }
        .login-box h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            letter-spacing: 3px;
            margin-bottom: 0.5rem;
        }
        .login-box h1 span { color: var(--red); }
        .login-box p {
            color: var(--muted);
            margin-bottom: 2rem;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .login-input {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--off-white);
            padding: 0.85rem 1rem;
            font-family: var(--font-mono);
            font-size: 12px;
            margin-bottom: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        .login-input:focus { border-color: var(--red); }
        .login-input::placeholder { color: var(--gray); }
        .login-btn {
            width: 100%;
            background: var(--red);
            color: var(--white);
            border: none;
            padding: 0.85rem;
            font-family: var(--font-mono);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .login-btn:hover { background: var(--red-bright); }
        .login-error {
            color: var(--red-bright);
            font-size: 11px;
            margin-top: 1rem;
            display: none;
        }

        /* â”€â”€â”€ DASHBOARD LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dashboard { display: none; }
        .dash-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: var(--darker);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .dash-logo {
            font-family: var(--font-display);
            font-size: 1.5rem;
            letter-spacing: 2px;
            text-decoration: none;
            color: var(--off-white);
        }
        .dash-logo span { color: var(--red); }
        .dash-actions { display: flex; gap: 1rem; align-items: center; }
        .dash-actions a, .dash-actions button {
            background: none;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 0.5rem 1rem;
            font-family: var(--font-mono);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }
        .dash-actions a:hover, .dash-actions button:hover {
            color: var(--off-white);
            border-color: var(--mid);
        }

        /* â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            background: var(--dark);
            overflow-x: auto;
        }
        .tab {
            padding: 1rem 2rem;
            font-family: var(--font-mono);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }
        .tab:hover { color: var(--off-white); }
        .tab.active {
            color: var(--red);
            border-bottom-color: var(--red);
        }
        .tab .badge {
            background: var(--red);
            color: #fff;
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 9px;
            margin-left: 6px;
            vertical-align: top;
        }
        .tab-content { display: none; padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .tab-content.active { display: block; }

        /* â”€â”€â”€ STATS CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--darker);
            border: 1px solid var(--border);
            padding: 1.5rem;
        }
        .stat-card .label {
            color: var(--muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 0.5rem;
        }
        .stat-card .value {
            font-family: var(--font-display);
            font-size: 2.5rem;
            color: var(--white);
            line-height: 1;
        }
        .stat-card .sub {
            color: var(--gray);
            font-size: 10px;
            margin-top: 0.35rem;
        }
        .stat-card.red .value { color: var(--red); }
        .stat-card.gold .value { color: var(--gold); }

        /* â”€â”€â”€ TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .table-wrap {
            overflow-x: auto;
            background: var(--darker);
            border: 1px solid var(--border);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: var(--surface);
            color: var(--muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            padding: 0.85rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            vertical-align: middle;
        }
        tr:hover { background: rgba(255,255,255,0.02); }

        .tier-badge {
            display: inline-block;
            padding: 2px 10px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid;
        }
        .tier-free { color: var(--muted); border-color: var(--mid); }
        .tier-peek { color: var(--red); border-color: var(--red); }
        .tier-vip { color: var(--gold); border-color: var(--gold); }
        .tier-elite { color: #fff; border-color: #fff; background: rgba(255,255,255,0.08); }

        .unread { background: rgba(194, 32, 32, 0.06); }
        .dot-unread {
            display: inline-block;
            width: 7px;
            height: 7px;
            background: var(--red);
            border-radius: 50%;
            margin-right: 6px;
        }

        /* â”€â”€â”€ ACTION BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-sm {
            background: none;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 3px 10px;
            font-family: var(--font-mono);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 4px;
        }
        .btn-sm:hover { color: var(--off-white); border-color: var(--mid); }
        .btn-sm.danger:hover { color: var(--red-bright); border-color: var(--red); }
        .btn-sm.primary { border-color: var(--red); color: var(--red); }
        .btn-sm.primary:hover { background: var(--red); color: #fff; }

        /* â”€â”€â”€ MESSAGE DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .msg-detail {
            background: var(--darker);
            border: 1px solid var(--border);
            padding: 2rem;
            margin-top: 1rem;
            display: none;
        }
        .msg-detail.active { display: block; }
        .msg-meta {
            color: var(--muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
        }
        .msg-body {
            color: var(--off-white);
            font-size: 13px;
            line-height: 1.8;
            padding: 1.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }
        .reply-box {
            display: flex;
            gap: 0.5rem;
        }
        .reply-input {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--off-white);
            padding: 0.75rem 1rem;
            font-family: var(--font-mono);
            font-size: 12px;
            outline: none;
            resize: vertical;
            min-height: 40px;
        }
        .reply-input:focus { border-color: var(--red); }
        .reply-send {
            background: var(--red);
            color: #fff;
            border: none;
            padding: 0.75rem 1.5rem;
            font-family: var(--font-mono);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            align-self: flex-end;
        }
        .reply-send:hover { background: var(--red-bright); }

        /* â”€â”€â”€ CONVERSATION THREAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .thread {
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }
        .thread-msg {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            max-width: 80%;
        }
        .thread-msg.from-user {
            background: var(--darker);
            border: 1px solid var(--border);
            margin-right: auto;
        }
        .thread-msg.from-admin {
            background: rgba(194, 32, 32, 0.12);
            border: 1px solid rgba(194, 32, 32, 0.3);
            margin-left: auto;
        }
        .thread-msg .msg-time {
            color: var(--gray);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.35rem;
        }

        /* â”€â”€â”€ COMPOSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .compose-form {
            background: var(--darker);
            border: 1px solid var(--border);
            padding: 2rem;
            margin-top: 1rem;
        }
        .compose-form label {
            display: block;
            color: var(--muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        .compose-form input, .compose-form textarea {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--off-white);
            padding: 0.75rem 1rem;
            font-family: var(--font-mono);
            font-size: 12px;
            margin-bottom: 1rem;
            outline: none;
        }
        .compose-form textarea { min-height: 120px; resize: vertical; }
        .compose-form input:focus, .compose-form textarea:focus { border-color: var(--red); }

        /* â”€â”€â”€ SECTION TITLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            letter-spacing: 2px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .section-title .icon { color: var(--red); }

        /* â”€â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .empty {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }
        .empty .icon { font-size: 2rem; margin-bottom: 1rem; }

        /* â”€â”€â”€ SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        select {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--off-white);
            padding: 3px 8px;
            font-family: var(--font-mono);
            font-size: 11px;
            outline: none;
            cursor: pointer;
        }

        /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 0.85rem 1.5rem;
            font-family: var(--font-mono);
            font-size: 11px;
            letter-spacing: 1px;
            z-index: 9999;
            transition: all 0.3s;
        }
        .toast-ok { background: var(--surface); color: var(--off-white); border: 1px solid var(--mid); }
        .toast-err { background: #2a0808; color: var(--red-bright); border: 1px solid var(--red); }

        /* â”€â”€â”€ PIPELINE SPECIFIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .pipe-filter.active {
            border-color: var(--red);
            color: var(--red);
        }
        #pipeDetail .compose-form select {
            width: 100%;
            margin-bottom: 0;
        }
        #pipeDetail .compose-form textarea {
            min-height: 80px;
        }

        /* â”€â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .cal-day {
            background: var(--darker);
            min-height: 90px;
            padding: 0.5rem;
            position: relative;
        }
        .cal-day.today {
            border: 1px solid var(--red);
        }
        .cal-day.other-month {
            background: var(--dark);
            opacity: 0.4;
        }
        .cal-day .day-num {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 0.3rem;
        }
        .cal-day.today .day-num {
            color: var(--red);
            font-weight: bold;
        }
        .cal-event {
            font-size: 9px;
            padding: 2px 4px;
            margin-bottom: 2px;
            border-radius: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .cal-event.scheduled { background: rgba(201, 168, 76, 0.2); color: var(--gold); border-left: 2px solid var(--gold); }
        .cal-event.published { background: rgba(46, 125, 50, 0.2); color: var(--green); border-left: 2px solid var(--green); }

        /* â”€â”€â”€ ANALYTICS BARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .bar-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
            font-size: 11px;
        }
        .bar-label {
            min-width: 80px;
            color: var(--muted);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 1px;
        }
        .bar-track {
            flex: 1;
            height: 14px;
            background: var(--surface);
            position: relative;
        }
        .bar-fill {
            height: 100%;
            background: var(--red);
            transition: width 0.4s ease;
        }
        .bar-count {
            min-width: 30px;
            text-align: right;
            color: var(--off-white);
        }

        /* â”€â”€â”€ SETTINGS CHECKBOXES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #tab-settings input[type="checkbox"] {
            accent-color: var(--red);
        }

        /* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            .dash-header { padding: 1rem; }
            .tab-content { padding: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            td, th { font-size: 11px; padding: 0.5rem; }
            .msg-detail { padding: 1rem; }
            .thread-msg { max-width: 95%; }
        }

        /* â”€â”€â”€ LOADING SPINNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--mid);
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            color: var(--muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 2rem;
            text-align: center;
        }

        .back-link {
            color: var(--muted);
            text-decoration: none;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 1rem;
        }
        .back-link:hover { color: var(--off-white); }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen" class="login-screen">
    <div class="login-box">
        <h1>INKED<span>MAYHEM</span></h1>
        <p>Admin Dashboard</p>
        <form id="loginForm">
            <input type="password" class="login-input" id="adminPass" placeholder="Admin password" autocomplete="current-password" autofocus>
            <button type="submit" class="login-btn" id="loginBtn">Enter</button>
        </form>
        <div class="login-error" id="loginError">Invalid password</div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboard" class="dashboard">
    <!-- HEADER -->
    <header class="dash-header">
        <a href="/admin" class="dash-logo">INKED<span>MAYHEM</span> âš¡ ADMIN</a>
        <div class="dash-actions">
            <a href="/" target="_blank">View Site</a>
            <button onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="pipeline">Pipeline <span class="badge" id="pipelineBadge" style="display:none">0</span></button>
        <button class="tab" data-tab="calendar">Calendar</button>
        <button class="tab" data-tab="analytics">Analytics</button>
        <button class="tab" data-tab="users">Users</button>
        <button class="tab" data-tab="messages">Messages <span class="badge" id="unreadBadge" style="display:none">0</span></button>
        <button class="tab" data-tab="conversations">Conversations</button>
        <button class="tab" data-tab="settings">Settings</button>
    </div>

    <!-- â”€â”€â”€ OVERVIEW TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content active" id="tab-overview">
        <div class="section-title"><span class="icon">â—†</span> Dashboard</div>
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="label">Total Users</div>
                <div class="value" id="statUsers">â€”</div>
            </div>
            <div class="stat-card red">
                <div class="label">Unread Messages</div>
                <div class="value" id="statUnread">â€”</div>
            </div>
            <div class="stat-card gold">
                <div class="label">Conversations</div>
                <div class="value" id="statConvos">â€”</div>
            </div>
            <div class="stat-card">
                <div class="label">Total Messages</div>
                <div class="value" id="statMsgs">â€”</div>
            </div>
        </div>

        <!-- Pipeline Overview in Dashboard -->
        <div class="section-title" style="font-size:1.3rem; margin-top: 2rem;"><span class="icon">â—†</span> Content Pipeline</div>
        <div class="stats-grid" id="overviewPipeGrid">
            <div class="stat-card"><div class="label">Pipeline Inbox</div><div class="value" id="overviewPipeInbox">â€”</div></div>
            <div class="stat-card gold"><div class="label">Queued</div><div class="value" id="overviewPipeQueued">â€”</div></div>
            <div class="stat-card"><div class="label">Published</div><div class="value" id="overviewPipePublished" style="color:var(--green)">â€”</div></div>
        </div>

        <div class="section-title" style="font-size:1.3rem; margin-top: 2rem;"><span class="icon">â—†</span> Tier Breakdown</div>
        <div class="stats-grid" id="tierGrid">
            <div class="stat-card"><div class="label">Free</div><div class="value" id="tierFree">â€”</div></div>
            <div class="stat-card"><div class="label">Peek</div><div class="value" id="tierPeek" style="color:var(--red)">â€”</div></div>
            <div class="stat-card"><div class="label">VIP</div><div class="value" id="tierVip" style="color:var(--gold)">â€”</div></div>
            <div class="stat-card"><div class="label">Elite</div><div class="value" id="tierElite" style="color:#fff">â€”</div></div>
        </div>
    </div>

    <!-- â”€â”€â”€ PIPELINE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content" id="tab-pipeline">
        <div class="section-title"><span class="icon">â—†</span> Content Pipeline</div>

        <!-- Pipeline Stats -->
        <div class="stats-grid" id="pipelineStatsGrid">
            <div class="stat-card">
                <div class="label">Inbox</div>
                <div class="value" id="pipeInbox">â€”</div>
                <div class="sub">Awaiting review</div>
            </div>
            <div class="stat-card">
                <div class="label">Processed</div>
                <div class="value" id="pipeProcessed">â€”</div>
                <div class="sub">Checks complete</div>
            </div>
            <div class="stat-card gold">
                <div class="label">Queued</div>
                <div class="value" id="pipeQueued">â€”</div>
                <div class="sub">Ready to publish</div>
            </div>
            <div class="stat-card" style="border-left: 2px solid var(--green)">
                <div class="label">Published</div>
                <div class="value" id="pipePublished" style="color:var(--green)">â€”</div>
            </div>
            <div class="stat-card red">
                <div class="label">Rejected</div>
                <div class="value" id="pipeRejected">â€”</div>
            </div>
        </div>

        <!-- Pipeline Actions -->
        <div style="display:flex; gap:0.5rem; margin-bottom:1.5rem; flex-wrap:wrap">
            <button class="btn-sm primary" onclick="pipeUploadModal()">+ Upload Content</button>
            <button class="btn-sm" onclick="pipeProcessAll()">Process All Inbox</button>
            <button class="btn-sm" onclick="pipePublishAll()">Publish All Queued</button>
            <button class="btn-sm" onclick="pipeCheckSchedule()">Run Schedule Check</button>
        </div>

        <!-- Pipeline Filters -->
        <div style="display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap">
            <button class="btn-sm pipe-filter active" data-filter="all" onclick="filterPipeline('all', this)">All</button>
            <button class="btn-sm pipe-filter" data-filter="inbox" onclick="filterPipeline('inbox', this)">Inbox</button>
            <button class="btn-sm pipe-filter" data-filter="processed" onclick="filterPipeline('processed', this)">Processed</button>
            <button class="btn-sm pipe-filter" data-filter="queued" onclick="filterPipeline('queued', this)">Queued</button>
            <button class="btn-sm pipe-filter" data-filter="published" onclick="filterPipeline('published', this)">Published</button>
            <button class="btn-sm pipe-filter" data-filter="rejected" onclick="filterPipeline('rejected', this)">Rejected</button>
        </div>

        <!-- Pipeline Table -->
        <div id="pipeLoading" class="loading-text"><span class="spinner"></span> Loading pipeline...</div>
        <div class="table-wrap" id="pipeTable" style="display:none">
            <table>
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>File</th>
                        <th>Caption</th>
                        <th>Category</th>
                        <th>Tier</th>
                        <th>Source</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="pipeBody"></tbody>
            </table>
        </div>
        <div class="empty" id="pipeEmpty" style="display:none">
            <div class="icon">ğŸ“‚</div>
            <p>No items in the pipeline. Upload content to get started.</p>
        </div>

        <!-- Item Detail / Edit Panel -->
        <div class="msg-detail" id="pipeDetail">
            <span class="back-link" onclick="closePipeDetail()">â† Back to pipeline</span>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:2rem; margin-top:1rem">
                <div>
                    <div class="msg-meta" id="pipeDetailMeta"></div>
                    <div id="pipeDetailPreview" style="margin:1rem 0; max-width:100%; background:var(--surface); border:1px solid var(--border); padding:1rem; text-align:center">
                        <span style="color:var(--gray)">Preview</span>
                    </div>
                    <div id="pipeDetailChecks" style="margin-top:1rem"></div>
                </div>
                <div>
                    <div class="compose-form" style="margin-top:0; border:none; padding:0; background:none">
                        <label>Caption</label>
                        <textarea id="pipeEditCaption" placeholder="Add a caption..."></textarea>
                        <label>Category</label>
                        <select id="pipeEditCategory">
                            <option value="photos">Photos</option>
                            <option value="selfies">Selfies</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="behind-the-scenes">Behind the Scenes</option>
                        </select>
                        <label style="margin-top:1rem">Access Tier</label>
                        <select id="pipeEditTier">
                            <option value="free">Free</option>
                            <option value="vip">VIP</option>
                            <option value="elite">Elite</option>
                        </select>
                        <label style="margin-top:1rem">Schedule (optional)</label>
                        <input type="datetime-local" id="pipeEditSchedule" style="width:100%; background:var(--surface); border:1px solid var(--border); color:var(--off-white); padding:0.75rem 1rem; font-family:var(--font-mono); font-size:12px">
                        <div style="display:flex; gap:0.5rem; margin-top:1.5rem; flex-wrap:wrap">
                            <button class="btn-sm primary" onclick="pipeApproveItem()">Approve + Queue</button>
                            <button class="btn-sm" onclick="pipeSaveItem()">Save Changes</button>
                            <button class="btn-sm" onclick="pipePublishItem()">Publish Now</button>
                            <button class="btn-sm danger" onclick="pipeRejectItem()">Reject</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Modal -->
        <div id="pipeUploadPanel" style="display:none">
            <div class="compose-form" style="margin-top:1rem">
                <div class="section-title" style="font-size: 1.2rem;"><span class="icon">â—†</span> Upload Content</div>
                <label>File</label>
                <input type="file" id="pipeFileInput" accept="image/*,video/*" style="background:var(--surface); border:1px solid var(--border); color:var(--off-white); padding:0.75rem; width:100%; font-family:var(--font-mono); font-size:12px; margin-bottom:1rem">
                <label>Caption</label>
                <input type="text" id="pipeUpCaption" placeholder="Optional caption" style="width:100%; background:var(--surface); border:1px solid var(--border); color:var(--off-white); padding:0.75rem 1rem; font-family:var(--font-mono); font-size:12px; margin-bottom:1rem">
                <div style="display:flex; gap:1rem; margin-bottom:1rem">
                    <div style="flex:1">
                        <label>Category</label>
                        <select id="pipeUpCategory" style="width:100%">
                            <option value="photos">Photos</option>
                            <option value="selfies">Selfies</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="behind-the-scenes">Behind the Scenes</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>Tier</label>
                        <select id="pipeUpTier" style="width:100%">
                            <option value="free">Free</option>
                            <option value="vip">VIP</option>
                            <option value="elite">Elite</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; gap:0.5rem">
                    <button class="login-btn" style="max-width:200px" id="pipeUploadBtn" onclick="pipeDoUpload()">Upload</button>
                    <button class="btn-sm" onclick="pipeCloseUpload()">Cancel</button>
                </div>
                <div id="pipeUploadProgress" style="display:none; margin-top:1rem; color:var(--muted); font-size:11px">
                    <span class="spinner"></span> Uploading...
                </div>
            </div>
        </div>

        <!-- Recent Activity Log -->
        <div style="margin-top:2rem">
            <div class="section-title" style="font-size:1.2rem"><span class="icon">â—†</span> Recent Activity</div>
            <div id="pipeActivityLog" style="background:var(--darker); border:1px solid var(--border); padding:1rem; max-height:300px; overflow-y:auto">
                <div class="loading-text"><span class="spinner"></span> Loading activity...</div>
            </div>
        </div>
    </div>

    <!-- â”€â”€â”€ USERS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content" id="tab-users">
        <div class="section-title"><span class="icon">â—†</span> Registered Users</div>
        <div id="usersLoading" class="loading-text"><span class="spinner"></span> Loading users...</div>
        <div class="table-wrap" id="usersTable" style="display:none">
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Name</th>
                        <th>Tier</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody"></tbody>
            </table>
        </div>
        <div class="empty" id="usersEmpty" style="display:none">
            <div class="icon">ğŸ‘¤</div>
            <p>No registered users yet</p>
        </div>
    </div>

    <!-- â”€â”€â”€ MESSAGES TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content" id="tab-messages">
        <div class="section-title"><span class="icon">â—†</span> Contact Messages</div>
        <div id="msgsLoading" class="loading-text"><span class="spinner"></span> Loading messages...</div>
        <div class="table-wrap" id="msgsTable" style="display:none">
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th>From</th>
                        <th>Subject</th>
                        <th>Preview</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="msgsBody"></tbody>
            </table>
        </div>
        <div class="msg-detail" id="msgDetail">
            <span class="back-link" onclick="closeMsgDetail()">â† Back to messages</span>
            <div class="msg-meta" id="msgDetailMeta"></div>
            <div class="msg-body" id="msgDetailBody"></div>
            <div id="msgReplies"></div>
            <div class="reply-box">
                <textarea class="reply-input" id="replyInput" placeholder="Type your reply..."></textarea>
                <button class="reply-send" id="replyBtn" onclick="sendReply()">Send</button>
            </div>
        </div>
        <div class="empty" id="msgsEmpty" style="display:none">
            <div class="icon">âœ‰ï¸</div>
            <p>No messages yet</p>
        </div>
    </div>

    <!-- â”€â”€â”€ CONVERSATIONS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content" id="tab-conversations">
        <div class="section-title"><span class="icon">â—†</span> Conversations</div>
        <div id="convoList">
            <div id="convosLoading" class="loading-text"><span class="spinner"></span> Loading conversations...</div>
            <div class="table-wrap" id="convosTable" style="display:none">
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Messages</th>
                            <th>Last Message</th>
                            <th>Last Activity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="convosBody"></tbody>
                </table>
            </div>
            <div class="empty" id="convosEmpty" style="display:none">
                <div class="icon">ğŸ’¬</div>
                <p>No conversations yet</p>
            </div>

            <!-- Compose new message -->
            <div class="compose-form" style="margin-top: 2rem">
                <div class="section-title" style="font-size: 1.2rem;"><span class="icon">â—†</span> Send New Message</div>
                <label>Recipient Email</label>
                <input type="email" id="composeEmail" placeholder="user@example.com">
                <label>Message</label>
                <textarea id="composeText" placeholder="Type your message..."></textarea>
                <button class="login-btn" style="max-width: 200px" onclick="composeSend()">Send Message</button>
            </div>
        </div>

        <!-- Thread view -->
        <div id="convoThread" style="display:none">
            <span class="back-link" onclick="closeThread()">â† Back to conversations</span>
            <div class="msg-meta" id="threadMeta"></div>
            <div class="thread" id="threadMessages"></div>
            <div class="reply-box">
                <textarea class="reply-input" id="threadReplyInput" placeholder="Type your message..."></textarea>
                <button class="reply-send" onclick="threadSend()">Send</button>
            </div>
        </div>
    </div>

    <!-- â”€â”€â”€ CALENDAR TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content" id="tab-calendar">
        <div class="section-title"><span class="icon">â—†</span> Content Calendar</div>
        <div style="display:flex; gap:1rem; margin-bottom:1.5rem; align-items:center">
            <button class="btn-sm" onclick="calPrevMonth()">&lt; Prev</button>
            <span id="calMonthLabel" style="font-family:var(--font-display); font-size:1.3rem; letter-spacing:2px; min-width:180px; text-align:center"></span>
            <button class="btn-sm" onclick="calNextMonth()">Next &gt;</button>
            <button class="btn-sm primary" onclick="calToday()" style="margin-left:1rem">Today</button>
        </div>
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:var(--border)">
            <div style="background:var(--surface); padding:0.5rem; text-align:center; color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px">Sun</div>
            <div style="background:var(--surface); padding:0.5rem; text-align:center; color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px">Mon</div>
            <div style="background:var(--surface); padding:0.5rem; text-align:center; color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px">Tue</div>
            <div style="background:var(--surface); padding:0.5rem; text-align:center; color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px">Wed</div>
            <div style="background:var(--surface); padding:0.5rem; text-align:center; color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px">Thu</div>
            <div style="background:var(--surface); padding:0.5rem; text-align:center; color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px">Fri</div>
            <div style="background:var(--surface); padding:0.5rem; text-align:center; color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px">Sat</div>
        </div>
        <div id="calGrid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:var(--border)"></div>

        <!-- Upcoming scheduled items -->
        <div style="margin-top:2rem">
            <div class="section-title" style="font-size:1.2rem"><span class="icon">â—†</span> Upcoming Scheduled Posts</div>
            <div id="calUpcoming" style="background:var(--darker); border:1px solid var(--border); padding:1rem">
                <div class="loading-text"><span class="spinner"></span> Loading schedule...</div>
            </div>
        </div>
    </div>

    <!-- â”€â”€â”€ ANALYTICS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content" id="tab-analytics">
        <div class="section-title"><span class="icon">â—†</span> Analytics & Monitoring</div>

        <!-- System Health -->
        <div class="section-title" style="font-size:1.2rem; margin-top:0"><span class="icon">â—†</span> System Health</div>
        <div id="healthStatus" class="stats-grid" style="margin-bottom:2rem">
            <div class="stat-card" id="healthCard" style="grid-column:span 2">
                <div class="label">System Status</div>
                <div class="value" id="healthValue" style="color:var(--green)">â€”</div>
                <div class="sub" id="healthSub">Checking...</div>
            </div>
            <div class="stat-card"><div class="label">Pipeline Store</div><div class="value" id="healthPipeline" style="font-size:1.5rem">â€”</div></div>
            <div class="stat-card"><div class="label">Users Store</div><div class="value" id="healthUsers" style="font-size:1.5rem">â€”</div></div>
        </div>

        <!-- Env Vars Check -->
        <div id="envCheck" style="background:var(--darker); border:1px solid var(--border); padding:1rem; margin-bottom:2rem">
            <div style="color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:0.75rem">Environment Configuration</div>
            <div id="envCheckGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:0.5rem"></div>
        </div>

        <!-- User Metrics -->
        <div class="section-title" style="font-size:1.2rem"><span class="icon">â—†</span> User Metrics</div>
        <div class="stats-grid" id="analyticsUserGrid">
            <div class="stat-card"><div class="label">Total Users</div><div class="value" id="anTotalUsers">â€”</div></div>
            <div class="stat-card gold"><div class="label">Paid Users</div><div class="value" id="anPaidUsers">â€”</div></div>
            <div class="stat-card"><div class="label">Conversion Rate</div><div class="value" id="anConversion" style="font-size:1.8rem">â€”</div></div>
            <div class="stat-card"><div class="label">Signups (7d)</div><div class="value" id="anSignups7d">â€”</div></div>
            <div class="stat-card"><div class="label">Signups (30d)</div><div class="value" id="anSignups30d">â€”</div></div>
            <div class="stat-card"><div class="label">Active (7d)</div><div class="value" id="anLogins7d">â€”</div></div>
        </div>

        <!-- Pipeline Metrics -->
        <div class="section-title" style="font-size:1.2rem; margin-top:2rem"><span class="icon">â—†</span> Pipeline Performance</div>
        <div class="stats-grid" id="analyticsPipeGrid">
            <div class="stat-card"><div class="label">Total Items</div><div class="value" id="anPipeTotal">â€”</div></div>
            <div class="stat-card"><div class="label">Published (7d)</div><div class="value" id="anPipePub7d" style="color:var(--green)">â€”</div></div>
            <div class="stat-card gold"><div class="label">Publish Rate</div><div class="value" id="anPipeRate" style="font-size:1.5rem">â€”</div></div>
            <div class="stat-card"><div class="label">Avg Process Time</div><div class="value" id="anPipeAvg" style="font-size:1.5rem">â€”</div></div>
            <div class="stat-card"><div class="label">Storage Used</div><div class="value" id="anPipeStorage" style="font-size:1.5rem">â€”</div></div>
        </div>

        <!-- Content Breakdown -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:2rem">
            <div style="background:var(--darker); border:1px solid var(--border); padding:1.5rem">
                <div style="color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:1rem">Upload Sources</div>
                <div id="anSourcesBreakdown"></div>
            </div>
            <div style="background:var(--darker); border:1px solid var(--border); padding:1.5rem">
                <div style="color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:1rem">Content by Tier</div>
                <div id="anTierBreakdown"></div>
            </div>
        </div>

        <!-- Telegram Metrics -->
        <div class="section-title" style="font-size:1.2rem; margin-top:2rem"><span class="icon">â—†</span> Telegram Bots</div>
        <div class="stats-grid">
            <div class="stat-card"><div class="label">Total Interactions</div><div class="value" id="anTgInteractions">â€”</div></div>
            <div class="stat-card red"><div class="label">Escalations</div><div class="value" id="anTgEscalations">â€”</div></div>
            <div class="stat-card"><div class="label">Unique Users</div><div class="value" id="anTgUsers">â€”</div></div>
            <div class="stat-card"><div class="label">Last 24h</div><div class="value" id="anTg24h">â€”</div></div>
        </div>

        <!-- Activity by Day -->
        <div style="margin-top:2rem">
            <div class="section-title" style="font-size:1.2rem"><span class="icon">â—†</span> Activity (Last 7 Days)</div>
            <div id="anActivityChart" style="background:var(--darker); border:1px solid var(--border); padding:1rem"></div>
        </div>

        <!-- FAQ Bot Insights -->
        <div class="section-title" style="font-size:1.2rem; margin-top:2rem"><span class="icon">â—†</span> FAQ Bot Insights</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
            <div style="background:var(--darker); border:1px solid var(--border); padding:1.5rem">
                <div style="display:flex; gap:2rem; margin-bottom:1rem">
                    <div>
                        <div style="font-size:2rem; font-weight:700; color:var(--red-bright)" id="anFaqHits">â€”</div>
                        <div style="color:var(--muted); font-size:11px">Total FAQ hits</div>
                    </div>
                    <div>
                        <div style="font-size:2rem; font-weight:700; color:var(--gold)" id="anFaqUnanswered">â€”</div>
                        <div style="color:var(--muted); font-size:11px">Unanswered</div>
                    </div>
                    <div>
                        <div style="font-size:2rem; font-weight:700; color:var(--red)" id="anFaqEscalations">â€”</div>
                        <div style="color:var(--muted); font-size:11px">Escalations</div>
                    </div>
                </div>
                <div style="color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:0.5rem">Top Categories</div>
                <div id="anFaqCategories"></div>
            </div>
            <div style="background:var(--darker); border:1px solid var(--border); padding:1.5rem">
                <div style="color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:0.5rem">Unanswered Questions</div>
                <div id="anFaqUnansweredList" style="max-height:250px; overflow-y:auto"></div>
            </div>
        </div>

        <!-- Data Export & Backup -->
        <div class="section-title" style="font-size:1.2rem; margin-top:2rem"><span class="icon">â—†</span> Data Export & Backup</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
            <div style="background:var(--darker); border:1px solid var(--border); padding:1.5rem">
                <div style="font-size:14px; font-weight:700; color:var(--off-white); margin-bottom:0.5rem">Full Backup</div>
                <div style="color:var(--muted); font-size:11px; margin-bottom:1rem">Download all data as JSON</div>
                <div id="anExportStats" style="font-size:11px; color:var(--muted); margin-bottom:1rem">Loading...</div>
                <button class="login-btn" style="max-width:220px" onclick="downloadFullBackup()">Download Full Backup</button>
            </div>
            <div style="background:var(--darker); border:1px solid var(--border); padding:1.5rem">
                <div style="font-size:14px; font-weight:700; color:var(--off-white); margin-bottom:0.5rem">Export Single Store</div>
                <select id="anExportStore" style="width:100%; background:var(--surface); border:1px solid var(--border); color:var(--off-white); padding:0.5rem; font-family:var(--font-mono); font-size:12px; margin-bottom:0.5rem">
                    <option value="users">users</option>
                    <option value="content">content</option>
                    <option value="pipeline">pipeline</option>
                    <option value="pipeline-logs">pipeline-logs</option>
                    <option value="conversations">conversations</option>
                    <option value="creator-configs">creator-configs</option>
                    <option value="telegram-logs">telegram-logs</option>
                    <option value="telegram-escalations">telegram-escalations</option>
                    <option value="telegram-faq-stats">telegram-faq-stats</option>
                </select>
                <button class="login-btn" style="max-width:180px; background:var(--mid)" onclick="downloadStoreExport()">Export Store</button>
            </div>
        </div>
    </div>

    <!-- â”€â”€â”€ SETTINGS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="tab-content" id="tab-settings">
        <div class="section-title"><span class="icon">â—†</span> Settings & Configuration</div>

        <!-- Creator Config -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:2rem">
            <div>
                <div class="section-title" style="font-size:1.2rem"><span class="icon">â—†</span> Creator Profile</div>
                <div class="compose-form" style="margin-top:0">
                    <label>Creator Name</label>
                    <input type="text" id="setCreatorName" placeholder="InkedMayhem">
                    <label>Handle</label>
                    <input type="text" id="setCreatorHandle" placeholder="@inkedmayhem">
                    <label>Creator Tier</label>
                    <select id="setCreatorTier" style="width:100%">
                        <option value="A">A â€” Manual approval</option>
                        <option value="B">B â€” Trusted (auto-publish)</option>
                        <option value="C">C â€” Scheduled</option>
                        <option value="D">D â€” Full automation</option>
                    </select>
                    <label style="margin-top:1rem">Moderation Level</label>
                    <select id="setModLevel" style="width:100%">
                        <option value="manual">Manual â€” Review everything</option>
                        <option value="trusted">Trusted â€” Auto-approve after checks</option>
                        <option value="scheduled">Scheduled â€” Auto-queue to schedule</option>
                    </select>
                    <button class="login-btn" style="max-width:200px; margin-top:1.5rem" onclick="saveCreatorConfig()">Save Profile</button>
                </div>
            </div>

            <div>
                <div class="section-title" style="font-size:1.2rem"><span class="icon">â—†</span> Telegram Bots</div>
                <div class="compose-form" style="margin-top:0">
                    <div id="tgBotStatus" style="margin-bottom:1rem">
                        <div style="display:flex; gap:1rem; margin-bottom:0.5rem">
                            <span id="tgCreatorStatus" style="font-size:11px"></span>
                            <span id="tgFanStatus" style="font-size:11px"></span>
                        </div>
                    </div>
                    <button class="btn-sm primary" onclick="setupTelegramBot('creator')">Setup Creator Bot</button>
                    <button class="btn-sm" onclick="setupTelegramBot('fan')">Setup Fan Bot</button>
                    <div id="tgSetupResult" style="margin-top:1rem; font-size:11px; color:var(--muted)"></div>
                </div>

                <div class="section-title" style="font-size:1.2rem; margin-top:2rem"><span class="icon">â—†</span> Content Rules</div>
                <div class="compose-form" style="margin-top:0">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; font-size:11px">
                        <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer">
                            <input type="checkbox" id="setStripExif" checked> Strip EXIF data
                        </label>
                        <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer">
                            <input type="checkbox" id="setCompress" checked> Compress images
                        </label>
                        <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer">
                            <input type="checkbox" id="setThumbnails" checked> Generate thumbnails
                        </label>
                        <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer">
                            <input type="checkbox" id="setAutoApprove"> Auto-approve after checks
                        </label>
                    </div>
                    <label style="margin-top:1rem">Max Image Size (MB)</label>
                    <input type="number" id="setMaxImageMB" value="25" min="1" max="100" style="width:100%">
                    <label>Max Video Size (MB)</label>
                    <input type="number" id="setMaxVideoMB" value="500" min="1" max="2000" style="width:100%">
                </div>
            </div>
        </div>

        <!-- Posting Schedule -->
        <div style="margin-top:2rem">
            <div class="section-title" style="font-size:1.2rem"><span class="icon">â—†</span> Posting Schedule</div>
            <div class="compose-form" style="margin-top:0">
                <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; margin-bottom:1rem">
                    <input type="checkbox" id="setScheduleEnabled"> Enable scheduled posting
                </label>
                <div id="scheduleSlots">
                    <div style="color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:0.5rem">Schedule Slots</div>
                    <div id="scheduleSlotsGrid" style="display:grid; gap:0.5rem"></div>
                    <button class="btn-sm" onclick="addScheduleSlot()" style="margin-top:0.5rem">+ Add Slot</button>
                </div>
                <button class="login-btn" style="max-width:200px; margin-top:1rem" onclick="saveScheduleConfig()">Save Schedule</button>
            </div>
        </div>

        <!-- Creators List (Multi-creator) -->
        <div style="margin-top:2rem">
            <div class="section-title" style="font-size:1.2rem"><span class="icon">â—†</span> Managed Creators</div>
            <div id="creatorsListLoading" class="loading-text"><span class="spinner"></span> Loading creators...</div>
            <div id="creatorsList" style="display:none"></div>
            <div class="compose-form" style="margin-top:1rem">
                <div class="section-title" style="font-size:1rem"><span class="icon">â—†</span> Onboard New Creator</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div>
                        <label>Creator Name</label>
                        <input type="text" id="onboardName" placeholder="Creator Name">
                    </div>
                    <div>
                        <label>Handle</label>
                        <input type="text" id="onboardHandle" placeholder="@handle">
                    </div>
                </div>
                <label>Tagline</label>
                <input type="text" id="onboardTagline" placeholder="Short brand tagline">
                <div style="display:flex; gap:0.5rem; margin-top:0.5rem">
                    <label style="display:flex; align-items:center; gap:0.3rem; font-size:11px; cursor:pointer"><input type="checkbox" id="onboardMembership"> Membership</label>
                    <label style="display:flex; align-items:center; gap:0.3rem; font-size:11px; cursor:pointer"><input type="checkbox" id="onboardBlog"> Blog</label>
                    <label style="display:flex; align-items:center; gap:0.3rem; font-size:11px; cursor:pointer"><input type="checkbox" id="onboardFaq"> FAQ Bot</label>
                </div>
                <button class="login-btn" style="max-width:200px; margin-top:1rem" onclick="onboardCreator()">Onboard Creator</button>
                <div id="onboardResult" style="margin-top:1rem; display:none"></div>
            </div>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN DASHBOARD â€” JavaScript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API = '/api/admin';
let TOKEN = localStorage.getItem('im_admin_token');
let currentMsgKey = null;
let currentConvKey = null;
let currentConvEmail = null;

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function headers() {
    return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` };
}

async function api(path, method = 'GET', body = null) {
    const opts = { method, headers: headers() };
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(`${API}${path}`, opts);
    return r.json();
}

document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const pass = document.getElementById('adminPass').value;
    const btn = document.getElementById('loginBtn');
    btn.textContent = 'Checking...';
    btn.disabled = true;

    try {
        const r = await fetch(`${API}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pass })
        });
        const data = await r.json();
        if (data.success) {
            TOKEN = data.token;
            localStorage.setItem('im_admin_token', TOKEN);
            showDashboard();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    } catch { document.getElementById('loginError').style.display = 'block'; }
    btn.textContent = 'Enter';
    btn.disabled = false;
});

function logout() {
    TOKEN = null;
    localStorage.removeItem('im_admin_token');
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('adminPass').value = '';
}

async function showDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadStats();
    loadPipelineStats();
}

// Check existing session
if (TOKEN) {
    // Verify token still works
    fetch(`${API}/stats`, { headers: { 'Authorization': `Bearer ${TOKEN}` } })
        .then(r => r.json())
        .then(d => { if (d.success) showDashboard(); else logout(); })
        .catch(() => logout());
}

// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');

        // Load data for tab
        if (tab.dataset.tab === 'users') loadUsers();
        if (tab.dataset.tab === 'messages') loadMessages();
        if (tab.dataset.tab === 'conversations') loadConversations();
        if (tab.dataset.tab === 'overview') { loadStats(); loadPipelineStats(); }
        if (tab.dataset.tab === 'pipeline') { loadPipeline(); loadPipelineStats(); }
        if (tab.dataset.tab === 'calendar') loadCalendar();
        if (tab.dataset.tab === 'analytics') loadAnalytics();
        if (tab.dataset.tab === 'settings') loadSettings();
    });
});

// â”€â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
    try {
        const data = await api('/stats');
        if (!data.success) return;
        const s = data.stats;
        document.getElementById('statUsers').textContent = s.totalUsers;
        document.getElementById('statUnread').textContent = s.unreadMessages;
        document.getElementById('statConvos').textContent = s.totalConversations;
        document.getElementById('statMsgs').textContent = s.totalMessages;
        document.getElementById('tierFree').textContent = s.tiers.free || 0;
        document.getElementById('tierPeek').textContent = s.tiers.peek || 0;
        document.getElementById('tierVip').textContent = s.tiers.vip || 0;
        document.getElementById('tierElite').textContent = s.tiers.elite || 0;

        const badge = document.getElementById('unreadBadge');
        if (s.unreadMessages > 0) {
            badge.textContent = s.unreadMessages;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    } catch (e) { console.error('Stats error:', e); }
}

// â”€â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsers() {
    document.getElementById('usersLoading').style.display = 'block';
    document.getElementById('usersTable').style.display = 'none';
    document.getElementById('usersEmpty').style.display = 'none';

    try {
        const data = await api('/users');
        document.getElementById('usersLoading').style.display = 'none';

        if (!data.success || !data.users.length) {
            document.getElementById('usersEmpty').style.display = 'block';
            return;
        }

        const tbody = document.getElementById('usersBody');
        tbody.innerHTML = data.users.map(u => `
            <tr>
                <td>${esc(u.email)}</td>
                <td>${esc(u.name)}</td>
                <td>
                    <select onchange="updateUserTier('${esc(u.key)}', this.value)">
                        ${['free','peek','vip','elite'].map(t =>
                            `<option value="${t}" ${u.tier===t?'selected':''}>${t.toUpperCase()}</option>`
                        ).join('')}
                    </select>
                </td>
                <td>${formatDate(u.createdAt)}</td>
                <td>
                    <button class="btn-sm" onclick="messageUser('${esc(u.email)}')">Message</button>
                    <button class="btn-sm danger" onclick="deleteUser('${esc(u.key)}', '${esc(u.email)}')">Delete</button>
                </td>
            </tr>
        `).join('');
        document.getElementById('usersTable').style.display = 'block';
    } catch (e) {
        document.getElementById('usersLoading').style.display = 'none';
        toast('Failed to load users', true);
    }
}

async function updateUserTier(key, tier) {
    const data = await api('/users/update', 'POST', { userKey: key, tier });
    if (data.success) toast(`Tier updated to ${tier.toUpperCase()}`);
    else toast('Update failed', true);
}

async function deleteUser(key, email) {
    if (!confirm(`Delete user ${email}? This cannot be undone.`)) return;
    const data = await api('/users/delete', 'POST', { userKey: key });
    if (data.success) { toast('User deleted'); loadUsers(); loadStats(); }
    else toast('Delete failed', true);
}

function messageUser(email) {
    // Switch to conversations tab and pre-fill compose
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('[data-tab="conversations"]').classList.add('active');
    document.getElementById('tab-conversations').classList.add('active');
    document.getElementById('composeEmail').value = email;
    document.getElementById('composeText').focus();
    loadConversations();
}

// â”€â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMessages() {
    document.getElementById('msgsLoading').style.display = 'block';
    document.getElementById('msgsTable').style.display = 'none';
    document.getElementById('msgsEmpty').style.display = 'none';
    document.getElementById('msgDetail').classList.remove('active');

    try {
        const data = await api('/messages');
        document.getElementById('msgsLoading').style.display = 'none';

        if (!data.success || !data.messages.length) {
            document.getElementById('msgsEmpty').style.display = 'block';
            return;
        }

        const tbody = document.getElementById('msgsBody');
        tbody.innerHTML = data.messages.map(m => `
            <tr class="${m.read ? '' : 'unread'}" data-key="${esc(m.key)}">
                <td>${m.read ? '' : '<span class="dot-unread"></span>'}</td>
                <td>${esc(m.name || m.email)}</td>
                <td>${esc(m.subject || 'â€”')}</td>
                <td style="color:var(--muted); max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${esc((m.message || '').substring(0, 60))}</td>
                <td style="white-space:nowrap">${formatDate(m.receivedAt)}</td>
                <td>
                    <button class="btn-sm primary" onclick="openMessage('${esc(m.key)}')">Open</button>
                    <button class="btn-sm danger" onclick="deleteMessage('${esc(m.key)}')">Delete</button>
                </td>
            </tr>
        `).join('');
        document.getElementById('msgsTable').style.display = 'block';
    } catch (e) {
        document.getElementById('msgsLoading').style.display = 'none';
        toast('Failed to load messages', true);
    }
}

async function openMessage(key) {
    currentMsgKey = key;
    // Find in current data
    const data = await api('/messages');
    const msg = data.messages.find(m => m.key === key);
    if (!msg) return;

    // Mark as read
    if (!msg.read) {
        await api('/messages/read', 'POST', { messageKey: key });
        loadStats();
    }

    document.getElementById('msgsTable').style.display = 'none';
    document.getElementById('msgDetailMeta').innerHTML = `
        From: <strong>${esc(msg.name)}</strong> &lt;${esc(msg.email)}&gt;<br>
        Subject: ${esc(msg.subject || 'â€”')} &nbsp;|&nbsp; ${formatDate(msg.receivedAt)}
        ${msg.fromMember ? ' &nbsp;|&nbsp; <span style="color:var(--gold)">MEMBER</span>' : ''}
    `;
    document.getElementById('msgDetailBody').textContent = msg.message;

    // Show replies if any
    const repliesDiv = document.getElementById('msgReplies');
    if (msg.replies && msg.replies.length) {
        repliesDiv.innerHTML = '<div style="margin-bottom:1rem;color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:1px">Replies</div>' +
            msg.replies.map(r => `
                <div style="background:rgba(194,32,32,0.08);border:1px solid rgba(194,32,32,0.2);padding:0.75rem 1rem;margin-bottom:0.5rem">
                    <div style="color:var(--off-white);font-size:12px">${esc(r.text)}</div>
                    <div style="color:var(--gray);font-size:9px;margin-top:0.3rem">${formatDate(r.sentAt)}</div>
                </div>
            `).join('');
    } else {
        repliesDiv.innerHTML = '';
    }

    document.getElementById('replyInput').value = '';
    document.getElementById('msgDetail').classList.add('active');
}

function closeMsgDetail() {
    document.getElementById('msgDetail').classList.remove('active');
    document.getElementById('msgsTable').style.display = 'block';
    loadMessages();
}

async function sendReply() {
    const text = document.getElementById('replyInput').value.trim();
    if (!text || !currentMsgKey) return;

    const btn = document.getElementById('replyBtn');
    btn.textContent = 'Sending...';
    btn.disabled = true;

    try {
        const data = await api('/messages/reply', 'POST', { messageKey: currentMsgKey, reply: text });
        if (data.success) {
            toast('Reply sent');
            openMessage(currentMsgKey); // Refresh to show reply
        } else toast('Reply failed', true);
    } catch { toast('Reply failed', true); }

    btn.textContent = 'Send';
    btn.disabled = false;
}

async function deleteMessage(key) {
    if (!confirm('Delete this message?')) return;
    const data = await api('/messages/delete', 'POST', { messageKey: key });
    if (data.success) { toast('Deleted'); loadMessages(); loadStats(); }
    else toast('Failed', true);
}

// â”€â”€â”€ CONVERSATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadConversations() {
    document.getElementById('convoList').style.display = 'block';
    document.getElementById('convoThread').style.display = 'none';
    document.getElementById('convosLoading').style.display = 'block';
    document.getElementById('convosTable').style.display = 'none';
    document.getElementById('convosEmpty').style.display = 'none';

    try {
        const data = await api('/conversations');
        document.getElementById('convosLoading').style.display = 'none';

        if (!data.success || !data.conversations.length) {
            document.getElementById('convosEmpty').style.display = 'block';
            return;
        }

        const tbody = document.getElementById('convosBody');
        tbody.innerHTML = data.conversations.map(c => `
            <tr>
                <td>${esc(c.email)}</td>
                <td>${c.messageCount}</td>
                <td style="color:var(--muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                    ${c.lastFrom === 'admin' ? '<span style="color:var(--red)">You:</span> ' : ''}${esc(c.lastMessage)}
                </td>
                <td>${formatDate(c.lastAt)}</td>
                <td><button class="btn-sm primary" onclick="openThread('${esc(c.key)}', '${esc(c.email)}')">Open</button></td>
            </tr>
        `).join('');
        document.getElementById('convosTable').style.display = 'block';
    } catch (e) {
        document.getElementById('convosLoading').style.display = 'none';
        toast('Failed to load conversations', true);
    }
}

async function openThread(key, email) {
    currentConvKey = key;
    currentConvEmail = email;
    document.getElementById('convoList').style.display = 'none';
    document.getElementById('convoThread').style.display = 'block';
    document.getElementById('threadMeta').innerHTML = `Conversation with <strong>${esc(email)}</strong>`;

    const data = await api('/conversations/thread', 'POST', { convKey: key });
    if (!data.success) return;

    const container = document.getElementById('threadMessages');
    container.innerHTML = data.conversation.messages.map(m => `
        <div class="thread-msg from-${m.from === 'admin' ? 'admin' : 'user'}">
            <div>${esc(m.text)}</div>
            <div class="msg-time">${m.from === 'admin' ? 'You' : email} Â· ${formatDate(m.sentAt)}</div>
        </div>
    `).join('');
    container.scrollTop = container.scrollHeight;
    document.getElementById('threadReplyInput').value = '';
}

function closeThread() {
    document.getElementById('convoThread').style.display = 'none';
    document.getElementById('convoList').style.display = 'block';
    loadConversations();
}

async function threadSend() {
    const text = document.getElementById('threadReplyInput').value.trim();
    if (!text || !currentConvEmail) return;

    const data = await api('/conversations/send', 'POST', { email: currentConvEmail, text });
    if (data.success) {
        toast('Sent');
        openThread(currentConvKey, currentConvEmail);
    } else toast('Failed', true);
}

async function composeSend() {
    const email = document.getElementById('composeEmail').value.trim();
    const text = document.getElementById('composeText').value.trim();
    if (!email || !text) { toast('Email and message required', true); return; }

    const data = await api('/conversations/send', 'POST', { email, text });
    if (data.success) {
        toast('Message sent');
        document.getElementById('composeEmail').value = '';
        document.getElementById('composeText').value = '';
        loadConversations();
    } else toast('Failed', true);
}

// â”€â”€â”€ PIPELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PIPE_API = '/api/pipeline';
let currentPipeFilter = 'all';
let currentPipeId = null;
let currentPipeItem = null;

async function pipeApi(path, method = 'GET', body = null) {
    const opts = { method, headers: headers() };
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(`${PIPE_API}${path}`, opts);
    return r.json();
}

async function loadPipelineStats() {
    try {
        const data = await pipeApi('/stats');
        if (!data.success) return;
        const p = data.pipeline;
        document.getElementById('pipeInbox').textContent = p.inbox;
        document.getElementById('pipeProcessed').textContent = p.processed;
        document.getElementById('pipeQueued').textContent = p.queued;
        document.getElementById('pipePublished').textContent = p.published;
        document.getElementById('pipeRejected').textContent = p.rejected;

        // Overview stats
        document.getElementById('overviewPipeInbox').textContent = p.inbox;
        document.getElementById('overviewPipeQueued').textContent = p.queued;
        document.getElementById('overviewPipePublished').textContent = p.published;

        // Badge
        const badge = document.getElementById('pipelineBadge');
        const pending = p.inbox + p.processed;
        if (pending > 0) {
            badge.textContent = pending;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }

        // Activity log
        if (data.recentActivity) {
            renderActivityLog(data.recentActivity);
        }
    } catch (e) { console.error('Pipeline stats error:', e); }
}

function renderActivityLog(logs) {
    const container = document.getElementById('pipeActivityLog');
    if (!logs.length) {
        container.innerHTML = '<div style="color:var(--gray); font-size:11px; text-align:center; padding:1rem">No recent activity</div>';
        return;
    }
    container.innerHTML = logs.map(log => {
        const time = formatDate(log.timestamp);
        const actionColors = {
            'ingest': 'var(--gold)',
            'process': 'var(--muted)',
            'approve': 'var(--green)',
            'reject': 'var(--red)',
            'publish': 'var(--green)',
            'delete': 'var(--red)',
            'telegram-upload': 'var(--gold)',
            'update': 'var(--muted)',
            'schedule-check': 'var(--muted)',
            'process-all': 'var(--muted)',
            'publish-all': 'var(--green)',
            'auto-queue': 'var(--gold)'
        };
        const color = actionColors[log.action] || 'var(--muted)';
        return `<div style="display:flex; justify-content:space-between; align-items:center; padding:0.4rem 0; border-bottom:1px solid var(--border); font-size:11px">
            <span><span style="color:${color}; text-transform:uppercase; letter-spacing:1px; font-size:10px">${esc(log.action)}</span> â€” ${esc(log.itemId || '')}</span>
            <span style="color:var(--gray)">${time}</span>
        </div>`;
    }).join('');
}

async function loadPipeline() {
    document.getElementById('pipeLoading').style.display = 'block';
    document.getElementById('pipeTable').style.display = 'none';
    document.getElementById('pipeEmpty').style.display = 'none';
    document.getElementById('pipeDetail').classList.remove('active');

    try {
        const data = await pipeApi(`/list?status=${currentPipeFilter}`);
        document.getElementById('pipeLoading').style.display = 'none';

        if (!data.success || !data.items.length) {
            document.getElementById('pipeEmpty').style.display = 'block';
            return;
        }

        const statusBadge = (status) => {
            const colors = {
                inbox: 'var(--gold)',
                processed: 'var(--muted)',
                queued: 'var(--gold)',
                published: 'var(--green)',
                rejected: 'var(--red)'
            };
            const c = colors[status] || 'var(--muted)';
            return `<span style="color:${c}; border:1px solid ${c}; padding:2px 8px; font-size:10px; text-transform:uppercase; letter-spacing:1px">${status}</span>`;
        };

        const tbody = document.getElementById('pipeBody');
        tbody.innerHTML = data.items.map(item => `
            <tr>
                <td>${statusBadge(item.status)}</td>
                <td style="max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${esc(item.filename)}</td>
                <td style="color:var(--muted); max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${esc(item.caption || 'â€”')}</td>
                <td>${esc(item.category || 'â€”')}</td>
                <td><span class="tier-badge tier-${item.tier || 'free'}">${(item.tier || 'free').toUpperCase()}</span></td>
                <td style="font-size:10px; color:var(--muted)">${esc(item.source || 'upload')}</td>
                <td style="white-space:nowrap">${formatDate(item.createdAt)}</td>
                <td>
                    <button class="btn-sm primary" onclick="openPipeItem('${esc(item.id)}')">Open</button>
                    ${item.status === 'inbox' ? `<button class="btn-sm" onclick="quickProcess('${esc(item.id)}')">Process</button>` : ''}
                    ${item.status === 'queued' ? `<button class="btn-sm" onclick="quickPublish('${esc(item.id)}')">Publish</button>` : ''}
                    <button class="btn-sm danger" onclick="pipeDeleteItem('${esc(item.id)}')">Del</button>
                </td>
            </tr>
        `).join('');
        document.getElementById('pipeTable').style.display = 'block';
    } catch (e) {
        document.getElementById('pipeLoading').style.display = 'none';
        toast('Failed to load pipeline', true);
    }
}

function filterPipeline(status, btn) {
    currentPipeFilter = status;
    document.querySelectorAll('.pipe-filter').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    loadPipeline();
}

async function openPipeItem(id) {
    try {
        const data = await pipeApi(`/item?id=${id}`);
        if (!data.success) { toast('Item not found', true); return; }

        currentPipeId = id;
        currentPipeItem = data.item;
        const item = data.item;

        document.getElementById('pipeTable').style.display = 'none';
        document.getElementById('pipeDetailMeta').innerHTML = `
            <strong>${esc(item.filename)}</strong><br>
            Status: <span style="color:var(--gold)">${item.status.toUpperCase()}</span> |
            Source: ${esc(item.source)} |
            Type: ${esc(item.mediaType)} |
            Size: ${item.fileSizeMB}MB<br>
            Created: ${formatDate(item.createdAt)}
            ${item.processedAt ? ` | Processed: ${formatDate(item.processedAt)}` : ''}
            ${item.publishedAt ? ` | Published: ${formatDate(item.publishedAt)}` : ''}
            ${item.scheduledAt ? `<br>Scheduled: ${item.scheduledAt}` : ''}
            ${item.rejectReason ? `<br><span style="color:var(--red)">Rejected: ${esc(item.rejectReason)}</span>` : ''}
        `;

        // Preview
        const preview = document.getElementById('pipeDetailPreview');
        if (item.mediaType === 'image' && item.storedAs) {
            preview.innerHTML = `<img src="/api/pipeline/asset/${esc(item.storedAs)}" style="max-width:100%; max-height:400px; object-fit:contain" onerror="this.parentNode.innerHTML='<span style=color:var(--gray)>Preview unavailable</span>'">`;
        } else if (item.mediaType === 'video') {
            preview.innerHTML = `<div style="color:var(--muted); padding:2rem">Video file â€” ${esc(item.filename)}</div>`;
        } else {
            preview.innerHTML = `<span style="color:var(--gray)">Preview unavailable</span>`;
        }

        // Checks
        const checks = item.checks || {};
        document.getElementById('pipeDetailChecks').innerHTML = `
            <div style="font-size:10px; text-transform:uppercase; letter-spacing:1px; color:var(--muted); margin-bottom:0.5rem">Content Checks</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.3rem; font-size:11px">
                <span>${checks.fileTypeValid ? 'âœ…' : 'âŒ'} File type valid</span>
                <span>${checks.fileSizeValid ? 'âœ…' : 'âŒ'} File size valid</span>
                <span>${checks.exifStripped ? 'âœ…' : 'â³'} EXIF stripped</span>
                <span>${checks.compressed ? 'âœ…' : 'â³'} Compressed</span>
                <span>${checks.thumbnailGenerated ? 'âœ…' : 'â³'} Thumbnail</span>
            </div>
        `;

        // Fill edit fields
        document.getElementById('pipeEditCaption').value = item.caption || '';
        document.getElementById('pipeEditCategory').value = item.category || 'photos';
        document.getElementById('pipeEditTier').value = item.tier || 'free';
        document.getElementById('pipeEditSchedule').value = item.scheduledAt ? item.scheduledAt.slice(0, 16) : '';

        document.getElementById('pipeDetail').classList.add('active');
    } catch (e) { toast('Failed to load item', true); }
}

function closePipeDetail() {
    document.getElementById('pipeDetail').classList.remove('active');
    document.getElementById('pipeTable').style.display = 'block';
    loadPipeline();
    loadPipelineStats();
}

async function pipeSaveItem() {
    if (!currentPipeId) return;
    const data = await pipeApi('/update', 'POST', {
        pipelineId: currentPipeId,
        caption: document.getElementById('pipeEditCaption').value,
        category: document.getElementById('pipeEditCategory').value,
        tier: document.getElementById('pipeEditTier').value,
        scheduledAt: document.getElementById('pipeEditSchedule').value || null
    });
    if (data.success) toast('Saved');
    else toast('Save failed', true);
}

async function pipeApproveItem() {
    if (!currentPipeId) return;
    const data = await pipeApi('/approve', 'POST', {
        pipelineId: currentPipeId,
        caption: document.getElementById('pipeEditCaption').value,
        category: document.getElementById('pipeEditCategory').value,
        tier: document.getElementById('pipeEditTier').value,
        scheduledAt: document.getElementById('pipeEditSchedule').value || null
    });
    if (data.success) { toast('Approved + queued'); closePipeDetail(); }
    else toast(data.error || 'Approve failed', true);
}

async function pipePublishItem() {
    if (!currentPipeId) return;
    // If item is not yet queued, approve first
    if (currentPipeItem && currentPipeItem.status !== 'queued') {
        const approve = await pipeApi('/approve', 'POST', {
            pipelineId: currentPipeId,
            caption: document.getElementById('pipeEditCaption').value,
            category: document.getElementById('pipeEditCategory').value,
            tier: document.getElementById('pipeEditTier').value
        });
        if (!approve.success) { toast('Failed to queue item first', true); return; }
    }
    const data = await pipeApi('/publish', 'POST', { pipelineId: currentPipeId });
    if (data.success) { toast('Published!'); closePipeDetail(); }
    else toast(data.error || 'Publish failed', true);
}

async function pipeRejectItem() {
    if (!currentPipeId) return;
    const reason = prompt('Reject reason (optional):') || '';
    const data = await pipeApi('/reject', 'POST', { pipelineId: currentPipeId, reason });
    if (data.success) { toast('Rejected'); closePipeDetail(); }
    else toast('Reject failed', true);
}

async function pipeDeleteItem(id) {
    if (!confirm('Delete this pipeline item?')) return;
    const data = await pipeApi('/delete', 'POST', { pipelineId: id });
    if (data.success) { toast('Deleted'); loadPipeline(); loadPipelineStats(); }
    else toast('Delete failed', true);
}

async function quickProcess(id) {
    const data = await pipeApi('/process', 'POST', { pipelineId: id });
    if (data.success) { toast('Processed'); loadPipeline(); loadPipelineStats(); }
    else toast('Process failed', true);
}

async function quickPublish(id) {
    const data = await pipeApi('/publish', 'POST', { pipelineId: id });
    if (data.success) { toast('Published!'); loadPipeline(); loadPipelineStats(); }
    else toast('Publish failed', true);
}

async function pipeProcessAll() {
    if (!confirm('Process all inbox items?')) return;
    const data = await pipeApi('/process-all', 'POST');
    if (data.success) { toast(`Processed ${data.processed} items`); loadPipeline(); loadPipelineStats(); }
    else toast('Batch process failed', true);
}

async function pipePublishAll() {
    if (!confirm('Publish all queued items?')) return;
    const data = await pipeApi('/publish-all', 'POST');
    if (data.success) { toast(`Published ${data.published} items`); loadPipeline(); loadPipelineStats(); }
    else toast('Batch publish failed', true);
}

async function pipeCheckSchedule() {
    const data = await pipeApi('/check-schedule', 'POST');
    if (data.success) { toast(`Schedule check: ${data.published} items published`); loadPipeline(); loadPipelineStats(); }
    else toast('Schedule check failed', true);
}

// Upload
function pipeUploadModal() {
    document.getElementById('pipeUploadPanel').style.display = 'block';
    document.getElementById('pipeFileInput').value = '';
    document.getElementById('pipeUpCaption').value = '';
}

function pipeCloseUpload() {
    document.getElementById('pipeUploadPanel').style.display = 'none';
}

async function pipeDoUpload() {
    const fileInput = document.getElementById('pipeFileInput');
    const file = fileInput.files[0];
    if (!file) { toast('Select a file first', true); return; }

    const btn = document.getElementById('pipeUploadBtn');
    const progress = document.getElementById('pipeUploadProgress');
    btn.disabled = true;
    btn.textContent = 'Uploading...';
    progress.style.display = 'block';

    try {
        // Read file as base64
        const reader = new FileReader();
        const fileData = await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        const data = await pipeApi('/ingest', 'POST', {
            filename: file.name,
            fileSize: file.size,
            fileData,
            caption: document.getElementById('pipeUpCaption').value,
            category: document.getElementById('pipeUpCategory').value,
            tier: document.getElementById('pipeUpTier').value,
            source: 'upload'
        });

        if (data.success) {
            toast('Uploaded to pipeline!');
            pipeCloseUpload();
            loadPipeline();
            loadPipelineStats();
        } else {
            toast(data.error || 'Upload failed', true);
        }
    } catch (e) {
        toast('Upload error', true);
        console.error('Upload error:', e);
    }

    btn.disabled = false;
    btn.textContent = 'Upload';
    progress.style.display = 'none';
}

// â”€â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth();
let calItems = [];

function calPrevMonth() { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); }
function calNextMonth() { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } renderCalendar(); }
function calToday() { calYear = new Date().getFullYear(); calMonth = new Date().getMonth(); renderCalendar(); }

async function loadCalendar() {
    try {
        const data = await pipeApi('/list?status=all');
        if (data.success) {
            calItems = data.items.filter(i => i.scheduledAt || i.publishedAt);
        }
    } catch {}
    renderCalendar();
    renderUpcoming();
}

function renderCalendar() {
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    document.getElementById('calMonthLabel').textContent = `${months[calMonth]} ${calYear}`;

    const grid = document.getElementById('calGrid');
    const firstDay = new Date(calYear, calMonth, 1).getDay();
    const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    let html = '';

    // Previous month padding
    const prevDays = new Date(calYear, calMonth, 0).getDate();
    for (let i = firstDay - 1; i >= 0; i--) {
        html += `<div class="cal-day other-month"><div class="day-num">${prevDays - i}</div></div>`;
    }

    // Current month days
    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = dateStr === todayStr;
        const events = calItems.filter(item => {
            const sched = item.scheduledAt?.split('T')[0];
            const pub = item.publishedAt?.split('T')[0];
            return sched === dateStr || pub === dateStr;
        });

        let eventsHtml = events.slice(0, 3).map(item => {
            const cls = item.status === 'published' ? 'published' : 'scheduled';
            const label = item.caption || item.filename || 'Untitled';
            return `<div class="cal-event ${cls}" title="${esc(label)}" onclick="openPipeItem('${esc(item.id)}')">${esc(label.substring(0, 15))}</div>`;
        }).join('');
        if (events.length > 3) eventsHtml += `<div style="font-size:9px; color:var(--muted)">+${events.length - 3} more</div>`;

        html += `<div class="cal-day${isToday ? ' today' : ''}"><div class="day-num">${d}</div>${eventsHtml}</div>`;
    }

    // Next month padding
    const totalCells = firstDay + daysInMonth;
    const remaining = (7 - (totalCells % 7)) % 7;
    for (let i = 1; i <= remaining; i++) {
        html += `<div class="cal-day other-month"><div class="day-num">${i}</div></div>`;
    }

    grid.innerHTML = html;
}

function renderUpcoming() {
    const now = new Date().toISOString();
    const upcoming = calItems
        .filter(i => i.status === 'queued' && i.scheduledAt && i.scheduledAt > now)
        .sort((a, b) => (a.scheduledAt || '').localeCompare(b.scheduledAt || ''));

    const container = document.getElementById('calUpcoming');
    if (upcoming.length === 0) {
        container.innerHTML = '<div style="color:var(--gray); font-size:11px; text-align:center; padding:1rem">No upcoming scheduled posts</div>';
        return;
    }

    container.innerHTML = upcoming.slice(0, 15).map(item => {
        const schedDate = new Date(item.scheduledAt);
        const relative = formatDate(item.scheduledAt);
        const dateStr = schedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const timeStr = schedDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        return `<div style="display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; border-bottom:1px solid var(--border)">
            <div>
                <span style="color:var(--gold); font-size:10px; text-transform:uppercase; letter-spacing:1px">SCHEDULED</span>
                <span style="margin-left:0.5rem">${esc(item.caption || item.filename)}</span>
                <span class="tier-badge tier-${item.tier || 'free'}" style="margin-left:0.5rem; font-size:9px">${(item.tier || 'free').toUpperCase()}</span>
            </div>
            <div style="text-align:right; font-size:11px">
                <div style="color:var(--off-white)">${dateStr} ${timeStr}</div>
                <div style="color:var(--gray); font-size:10px">${relative}</div>
            </div>
        </div>`;
    }).join('');
}

// â”€â”€â”€ ANALYTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AN_API = '/api/analytics';

async function anApi(path) {
    const r = await fetch(`${AN_API}${path}`, { headers: headers() });
    return r.json();
}

async function loadAnalytics() {
    // Load health check (no auth needed)
    loadHealthCheck();

    // Load dashboard metrics
    try {
        const data = await anApi('/dashboard');
        if (!data.success) return;

        // User metrics
        document.getElementById('anTotalUsers').textContent = data.users.total;
        document.getElementById('anPaidUsers').textContent = data.users.paidUsers;
        document.getElementById('anConversion').textContent = data.users.conversionRate;
        document.getElementById('anSignups7d').textContent = data.users.recentSignups7d;
        document.getElementById('anSignups30d').textContent = data.users.recentSignups30d;
        document.getElementById('anLogins7d').textContent = data.users.recentLogins7d;

        // Pipeline metrics
        document.getElementById('anPipeTotal').textContent = data.pipeline.total;
        document.getElementById('anPipePub7d').textContent = data.pipeline.publishedLast7d;
        document.getElementById('anPipeRate').textContent = data.pipeline.publishRate7d;
        document.getElementById('anPipeAvg').textContent = data.pipeline.avgProcessingTime;
        document.getElementById('anPipeStorage').textContent = data.pipeline.totalSizeMB + 'MB';

        // Sources breakdown
        renderBarChart('anSourcesBreakdown', data.pipeline.sources || {});

        // Tier breakdown
        renderBarChart('anTierBreakdown', data.content.tierBreakdown || {});

        // Telegram
        document.getElementById('anTgInteractions').textContent = data.telegram.totalInteractions;
        document.getElementById('anTgEscalations').textContent = data.telegram.totalEscalations;
        document.getElementById('anTgUsers').textContent = data.telegram.uniqueUsers;
        document.getElementById('anTg24h').textContent = data.telegram.recent24h;
    } catch (e) { console.error('Analytics error:', e); }

    // Load activity chart
    loadActivityChart();

    // Load FAQ insights
    loadFaqInsights();

    // Load export stats
    loadExportStats();
}

async function loadFaqInsights() {
    try {
        const r = await fetch(`${AN_API}/faq`, { headers: authHeaders() });
        const data = await r.json();
        if (!data.success) return;

        const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        setEl('anFaqHits', data.totalHits || 0);
        setEl('anFaqUnanswered', data.unansweredCount || 0);
        setEl('anFaqEscalations', data.escalationCount || 0);

        const catEl = document.getElementById('anFaqCategories');
        if (catEl && data.topCategories?.length) {
            catEl.innerHTML = data.topCategories.map(c =>
                `<div style="display:flex; justify-content:space-between; padding:0.25rem 0; border-bottom:1px solid var(--border)">
                    <span style="text-transform:capitalize">${esc(c.category)}</span>
                    <span style="color:var(--red-bright); font-weight:700">${c.hits}</span>
                </div>`
            ).join('');
        } else if (catEl) {
            catEl.innerHTML = '<div style="color:var(--gray); font-size:11px">No FAQ data yet</div>';
        }

        const unEl = document.getElementById('anFaqUnansweredList');
        if (unEl && data.unansweredQuestions?.length) {
            unEl.innerHTML = data.unansweredQuestions.map(q =>
                `<div style="padding:0.3rem 0; border-bottom:1px solid var(--border)">
                    <div style="color:var(--off-white); font-size:11px">"${esc((q.question || '').substring(0, 120))}"</div>
                    <div style="color:var(--gray); font-size:10px">${q.timestamp ? new Date(q.timestamp).toLocaleDateString() : ''}</div>
                </div>`
            ).join('');
        } else if (unEl) {
            unEl.innerHTML = '<div style="color:var(--gray); font-size:11px">No unanswered questions</div>';
        }
    } catch (e) { console.error('FAQ insights error:', e); }
}

async function loadExportStats() {
    try {
        const r = await fetch('/api/admin-export/stats', { headers: authHeaders() });
        const data = await r.json();
        if (!data.success) return;
        const el = document.getElementById('anExportStats');
        if (!el) return;
        const entries = Object.entries(data.stores).filter(([,v]) => v > 0);
        el.innerHTML = entries.map(([name, count]) =>
            `<span style="display:inline-block; background:rgba(255,255,255,0.06); padding:2px 8px; border-radius:3px; margin:2px">${name}: <b>${count}</b></span>`
        ).join(' ') + `<div style="margin-top:0.5rem; color:var(--gold)">Total: ${data.totalItems} items</div>`;
    } catch { const el = document.getElementById('anExportStats'); if (el) el.textContent = 'Could not load stats'; }
}

async function downloadFullBackup() {
    try {
        showToast('Generating backup...');
        const r = await fetch('/api/admin-export', { headers: authHeaders() });
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `inkedmayhem-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Backup downloaded!');
    } catch { showToast('Backup failed'); }
}

async function downloadStoreExport() {
    const storeName = document.getElementById('anExportStore')?.value || 'users';
    try {
        showToast(`Exporting ${storeName}...`);
        const r = await fetch(`/api/admin-export/store?name=${storeName}`, { headers: authHeaders() });
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${storeName}-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast(`${storeName} exported!`);
    } catch { showToast('Export failed'); }
}

async function loadHealthCheck() {
    try {
        const r = await fetch(`${AN_API}/health`);
        const data = await r.json();

        const statusEl = document.getElementById('healthValue');
        const subEl = document.getElementById('healthSub');
        statusEl.textContent = data.status === 'ok' ? 'OK' : 'DEGRADED';
        statusEl.style.color = data.status === 'ok' ? 'var(--green)' : 'var(--red)';
        subEl.textContent = `Last checked: ${formatDate(data.timestamp)}`;

        document.getElementById('healthPipeline').textContent = data.stores?.pipeline?.ok ? 'OK' : 'ERR';
        document.getElementById('healthPipeline').style.color = data.stores?.pipeline?.ok ? 'var(--green)' : 'var(--red)';
        document.getElementById('healthUsers').textContent = data.stores?.users?.ok ? 'OK' : 'ERR';
        document.getElementById('healthUsers').style.color = data.stores?.users?.ok ? 'var(--green)' : 'var(--red)';

        // Env vars
        if (data.env) {
            const envGrid = document.getElementById('envCheckGrid');
            const envNames = {
                jwtSecret: 'JWT Secret', stripeKey: 'Stripe Key', telegramCreator: 'Creator Bot',
                telegramFan: 'Fan Bot', resendApi: 'Resend API', notifyEmail: 'Notify Email'
            };
            envGrid.innerHTML = Object.entries(data.env).map(([k, v]) =>
                `<div style="display:flex; align-items:center; gap:0.5rem; font-size:11px">
                    <span style="color:${v ? 'var(--green)' : 'var(--red)'}">${v ? 'â—' : 'â—‹'}</span>
                    <span style="color:${v ? 'var(--off-white)' : 'var(--gray)'}">${envNames[k] || k}</span>
                </div>`
            ).join('');
        }
    } catch (e) {
        document.getElementById('healthValue').textContent = 'ERROR';
        document.getElementById('healthValue').style.color = 'var(--red)';
    }
}

function renderBarChart(containerId, data) {
    const container = document.getElementById(containerId);
    const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);
    const max = Math.max(...entries.map(e => e[1]), 1);

    if (entries.length === 0) {
        container.innerHTML = '<div style="color:var(--gray); font-size:11px">No data</div>';
        return;
    }

    container.innerHTML = entries.map(([label, count]) => `
        <div class="bar-row">
            <span class="bar-label">${esc(label)}</span>
            <div class="bar-track"><div class="bar-fill" style="width:${(count / max * 100).toFixed(0)}%"></div></div>
            <span class="bar-count">${count}</span>
        </div>
    `).join('');
}

async function loadActivityChart() {
    try {
        const data = await anApi('/activity?days=7');
        if (!data.success) return;

        const container = document.getElementById('anActivityChart');
        const days = Object.keys(data.byDay).sort();

        if (days.length === 0) {
            container.innerHTML = '<div style="color:var(--gray); font-size:11px; text-align:center; padding:1rem">No activity in the last 7 days</div>';
            return;
        }

        // Build a simple bar chart per day
        const maxPerDay = Math.max(...days.map(d => Object.values(data.byDay[d]).reduce((a, b) => a + b, 0)), 1);

        container.innerHTML = days.map(day => {
            const actions = data.byDay[day];
            const total = Object.values(actions).reduce((a, b) => a + b, 0);
            const barWidth = (total / maxPerDay * 100).toFixed(0);
            const dayLabel = new Date(day + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const breakdown = Object.entries(actions).map(([a, c]) => `${a}: ${c}`).join(', ');

            return `<div class="bar-row" title="${breakdown}">
                <span class="bar-label" style="min-width:100px">${dayLabel}</span>
                <div class="bar-track"><div class="bar-fill" style="width:${barWidth}%; background:var(--gold)"></div></div>
                <span class="bar-count">${total}</span>
            </div>`;
        }).join('');
    } catch (e) { console.error('Activity chart error:', e); }
}

// â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CONFIG_API = '/api/creator-config';

async function configApi(path, method = 'GET', body = null) {
    const opts = { method, headers: headers() };
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(`${CONFIG_API}${path}`, opts);
    return r.json();
}

async function loadSettings() {
    // Load current creator config
    try {
        const data = await configApi('/get?id=inkedmayhem');
        if (data.success && data.config) {
            const c = data.config;
            document.getElementById('setCreatorName').value = c.name || '';
            document.getElementById('setCreatorHandle').value = c.handle || '';
            document.getElementById('setCreatorTier').value = c.creatorTier || 'A';
            document.getElementById('setModLevel').value = c.moderation?.level || 'manual';
            document.getElementById('setStripExif').checked = c.contentRules?.stripExif !== false;
            document.getElementById('setCompress').checked = c.contentRules?.compressImages !== false;
            document.getElementById('setThumbnails').checked = c.contentRules?.generateThumbnails !== false;
            document.getElementById('setAutoApprove').checked = c.moderation?.autoApproveAfterChecks === true;
            document.getElementById('setMaxImageMB').value = c.contentRules?.maxImageSizeMB || 25;
            document.getElementById('setMaxVideoMB').value = c.contentRules?.maxVideoSizeMB || 500;
            document.getElementById('setScheduleEnabled').checked = c.postingSchedule?.enabled === true;

            // Render schedule slots
            renderScheduleSlots(c.postingSchedule?.slots || []);
        }
    } catch {}

    // Load telegram bot status
    loadBotStatus();

    // Load creators list
    loadCreatorsList();
}

async function saveCreatorConfig() {
    try {
        const data = await configApi('/save', 'POST', {
            config: {
                id: 'inkedmayhem',
                name: document.getElementById('setCreatorName').value,
                handle: document.getElementById('setCreatorHandle').value,
                creatorTier: document.getElementById('setCreatorTier').value,
                moderation: {
                    level: document.getElementById('setModLevel').value,
                    autoApproveAfterChecks: document.getElementById('setAutoApprove').checked,
                    notifyOnUpload: true,
                    notifyOnPublish: true
                },
                contentRules: {
                    stripExif: document.getElementById('setStripExif').checked,
                    compressImages: document.getElementById('setCompress').checked,
                    generateThumbnails: document.getElementById('setThumbnails').checked,
                    maxImageSizeMB: parseInt(document.getElementById('setMaxImageMB').value) || 25,
                    maxVideoSizeMB: parseInt(document.getElementById('setMaxVideoMB').value) || 500
                }
            }
        });
        if (data.success) toast('Creator config saved');
        else toast('Save failed', true);
    } catch { toast('Save failed', true); }
}

function renderScheduleSlots(slots) {
    const grid = document.getElementById('scheduleSlotsGrid');
    if (!slots.length) {
        grid.innerHTML = '<div style="color:var(--gray); font-size:11px">No schedule slots configured</div>';
        return;
    }
    grid.innerHTML = slots.map((slot, i) => `
        <div style="display:flex; gap:0.5rem; align-items:center">
            <select onchange="updateSlotDay(${i}, this.value)" style="flex:1">
                ${['sunday','monday','tuesday','wednesday','thursday','friday','saturday'].map(d =>
                    `<option value="${d}" ${slot.day === d ? 'selected' : ''}>${d.charAt(0).toUpperCase() + d.slice(1)}</option>`
                ).join('')}
            </select>
            <input type="time" value="${slot.time || '20:00'}" onchange="updateSlotTime(${i}, this.value)" style="background:var(--surface); border:1px solid var(--border); color:var(--off-white); padding:0.4rem; font-family:var(--font-mono); font-size:11px">
            <button class="btn-sm danger" onclick="removeSlot(${i})">X</button>
        </div>
    `).join('');
}

let scheduleSlots = [];

function addScheduleSlot() {
    scheduleSlots.push({ day: 'monday', time: '20:00', timezone: 'America/New_York' });
    renderScheduleSlots(scheduleSlots);
}

function updateSlotDay(i, day) { if (scheduleSlots[i]) scheduleSlots[i].day = day; }
function updateSlotTime(i, time) { if (scheduleSlots[i]) scheduleSlots[i].time = time; }
function removeSlot(i) { scheduleSlots.splice(i, 1); renderScheduleSlots(scheduleSlots); }

async function saveScheduleConfig() {
    try {
        const data = await configApi('/save', 'POST', {
            config: {
                id: 'inkedmayhem',
                postingSchedule: {
                    enabled: document.getElementById('setScheduleEnabled').checked,
                    slots: scheduleSlots,
                    autoFillSlots: true
                }
            }
        });
        if (data.success) toast('Schedule saved');
        else toast('Save failed', true);
    } catch { toast('Save failed', true); }
}

async function loadBotStatus() {
    const creatorEl = document.getElementById('tgCreatorStatus');
    const fanEl = document.getElementById('tgFanStatus');

    try {
        const health = await fetch(`${AN_API}/health`).then(r => r.json());
        const creatorOk = health.env?.telegramCreator;
        const fanOk = health.env?.telegramFan;

        creatorEl.innerHTML = `<span style="color:${creatorOk ? 'var(--green)' : 'var(--red)'}">â— Creator Bot: ${creatorOk ? 'Configured' : 'Not Set'}</span>`;
        fanEl.innerHTML = `<span style="color:${fanOk ? 'var(--green)' : 'var(--red)'}">â— Fan Bot: ${fanOk ? 'Configured' : 'Not Set'}</span>`;
    } catch {
        creatorEl.innerHTML = '<span style="color:var(--gray)">â— Creator Bot: Unknown</span>';
        fanEl.innerHTML = '<span style="color:var(--gray)">â— Fan Bot: Unknown</span>';
    }
}

async function setupTelegramBot(botType) {
    const resultEl = document.getElementById('tgSetupResult');
    resultEl.textContent = 'Setting up webhook...';

    try {
        const r = await fetch('/api/telegram/setup', {
            method: 'POST',
            headers: headers(),
            body: JSON.stringify({ botType })
        });
        const data = await r.json();
        if (data.success) {
            resultEl.innerHTML = `<span style="color:var(--green)">Webhook set: ${esc(data.webhookUrl)}</span>`;
            toast(`${botType} bot webhook configured`);
            loadBotStatus();
        } else {
            resultEl.innerHTML = `<span style="color:var(--red)">${esc(data.error || 'Setup failed')}</span>`;
        }
    } catch {
        resultEl.innerHTML = '<span style="color:var(--red)">Setup failed â€” check bot token</span>';
    }
}

async function loadCreatorsList() {
    try {
        const data = await configApi('/list');
        document.getElementById('creatorsListLoading').style.display = 'none';
        const container = document.getElementById('creatorsList');

        if (!data.success || !data.creators?.length) {
            container.style.display = 'block';
            container.innerHTML = '<div style="background:var(--darker); border:1px solid var(--border); padding:1rem; color:var(--gray); font-size:11px">No creators configured yet. Use onboarding below to add one.</div>';
            return;
        }

        container.style.display = 'block';
        container.innerHTML = `<div class="table-wrap"><table>
            <thead><tr><th>Name</th><th>Handle</th><th>Tier</th><th>Domain</th><th>Created</th></tr></thead>
            <tbody>${data.creators.map(c => `
                <tr>
                    <td>${esc(c.name)}</td>
                    <td style="color:var(--muted)">${esc(c.handle)}</td>
                    <td><span class="tier-badge" style="color:var(--gold); border-color:var(--gold)">${c.creatorTier || 'A'}</span></td>
                    <td style="color:var(--muted); font-size:11px">${esc(c.domain || 'â€”')}</td>
                    <td>${formatDate(c.createdAt)}</td>
                </tr>
            `).join('')}</tbody>
        </table></div>`;
    } catch {
        document.getElementById('creatorsListLoading').style.display = 'none';
    }
}

async function onboardCreator() {
    const name = document.getElementById('onboardName').value.trim();
    if (!name) { toast('Creator name required', true); return; }

    try {
        const data = await configApi('/onboard', 'POST', {
            name,
            handle: document.getElementById('onboardHandle').value.trim(),
            tagline: document.getElementById('onboardTagline').value.trim(),
            membership: document.getElementById('onboardMembership').checked,
            blog: document.getElementById('onboardBlog').checked,
            faq: document.getElementById('onboardFaq').checked
        });

        const resultEl = document.getElementById('onboardResult');
        if (data.success) {
            resultEl.style.display = 'block';
            resultEl.innerHTML = `
                <div style="background:rgba(46,125,50,0.1); border:1px solid var(--green); padding:1rem; color:var(--green); font-size:11px">
                    <strong>Creator onboarded!</strong><br>
                    ID: ${esc(data.creatorId)}<br>
                    Domain: ${esc(data.config?.domain || '')}<br><br>
                    <strong>Next steps:</strong><br>
                    ${(data.nextSteps || []).map(s => `â€¢ ${esc(s)}`).join('<br>')}
                </div>`;
            toast('Creator onboarded!');
            loadCreatorsList();
            document.getElementById('onboardName').value = '';
            document.getElementById('onboardHandle').value = '';
            document.getElementById('onboardTagline').value = '';
        } else {
            resultEl.style.display = 'block';
            resultEl.innerHTML = `<div style="color:var(--red); font-size:11px">${esc(data.error || 'Onboard failed')}</div>`;
        }
    } catch { toast('Onboard failed', true); }
}

// â”€â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

function formatDate(iso) {
    if (!iso || iso === 'â€”') return 'â€”';
    try {
        const d = new Date(iso);
        const now = new Date();
        const diff = now - d;
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
        if (diff < 604800000) return `${Math.floor(diff/86400000)}d ago`;
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    } catch { return iso; }
}

function toast(msg, err = false) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const t = document.createElement('div');
    t.className = `toast ${err ? 'toast-err' : 'toast-ok'}`;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2500);
}
</script>
</body>
</html>
